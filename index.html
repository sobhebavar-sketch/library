<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú©Ø§Ù†ÙˆÙ† Ù…Ù‡Ø¯ÙˆÛŒØª ØµØ¨Ø­ Ø¨Ø§ÙˆØ±</title>
  <meta name="description" content="Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø¯Ù‡ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ â€” Ù†Ù…Ø§ÛŒØ´ Ø¹Ù…ÙˆÙ…ÛŒ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆØ³Ø· Ú©ØªØ§Ø¨Ø¯Ø§Ø±" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.2.0/dist/persian-date.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.js"></script>
  <style>
    html, body { height: 100%; background: #0b1020; }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.08); }
    .chip { border:1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.05); }
    input, select, textarea { background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); }
    label { font-size: 12px; color: rgba(226,232,240,.8); }
  </style>
</head>
<body class="text-slate-100">
  <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <img id="logo" alt="Ù„ÙˆÚ¯Ùˆ" class="w-10 h-10 rounded-2xl border border-white/20 object-cover hidden" />
        <span id="logoFallback" class="inline-flex items-center justify-center w-10 h-10 rounded-2xl bg-indigo-500/20 border border-indigo-400/30">
          <i data-lucide="book" class="w-6 h-6 text-indigo-300"></i>
        </span>
        <div>
          <h1 class="text-2xl font-bold">Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú©Ø§Ù†ÙˆÙ† Ù…Ù‡Ø¯ÙˆÛŒØª ØµØ¨Ø­ Ø¨Ø§ÙˆØ±</h1>
          <p id="tagline" class="text-xs text-slate-300/70">Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒØ› Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆØ³Ø· Ú©ØªØ§Ø¨Ø¯Ø§Ø±</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="btnAdminAuth" class="px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">ÙˆØ±ÙˆØ¯ Ú©ØªØ§Ø¨Ø¯Ø§Ø±</button>
        <div id="userBox" class="hidden items-center gap-3"></div>
      </div>
    </header>

    <section id="catalog" class="glass rounded-3xl p-5 mb-6">
      <div class="flex flex-col sm:flex-row gap-3 items-center justify-between mb-4">
        <div class="flex gap-2 w-full sm:w-auto">
          <input id="search" class="rounded-xl px-3 py-2 w-full sm:w-96" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†ØŒ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡ØŒ Ù…ØªØ±Ø¬Ù…ØŒ Ù…ÙˆØ¶ÙˆØ¹ØŒ Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡ØŒ Ù†Ø§Ø´Ø±ØŒ Ø³Ø§Ù„ØŒ ISBN" />
          <button id="btnSearch" class="px-4 py-2 rounded-xl bg-indigo-500">Ø¬Ø³ØªØ¬Ùˆ</button>
        </div>
        <div class="text-sm text-slate-300/80">ØªØ¹Ø¯Ø§Ø¯: <span class="px-2 py-1 rounded-lg chip" id="catalogCount">â€”</span></div>
      </div>
      <div id="catalogList" class="grid lg:grid-cols-2 gap-3"></div>
    </section>

    <section id="adminShell" class="hidden">
      <div class="flex flex-wrap gap-2 mb-4">
        <button data-tab="admin-books" class="tab chip px-4 py-2 rounded-xl">ğŸ“š Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</button>
        <button data-tab="admin-members" class="tab chip px-4 py-2 rounded-xl">ğŸ‘¥ Ø§Ø¹Ø¶Ø§</button>
        <button data-tab="admin-loans" class="tab chip px-4 py-2 rounded-xl">ğŸ”„ Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§</button>
        <button data-tab="admin-import" class="tab chip px-4 py-2 rounded-xl">â¬†ï¸ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª/â¬‡ï¸ Ø§Ú©Ø³Ù¾ÙˆØ±Øª</button>
        <button data-tab="admin-settings" class="tab chip px-4 py-2 rounded-xl">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
      </div>

      <div id="tab-admin-books" class="glass rounded-3xl p-5 hidden">
        <h3 class="font-bold mb-4">Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ú©ØªØ§Ø¨</h3>
        <form id="bookForm" class="grid md:grid-cols-3 gap-4 mb-6">
          <div class="md:col-span-2 grid grid-cols-2 gap-4">
            <div class="col-span-2">
              <label>Ø¹Ù†ÙˆØ§Ù† *</label>
              <input id="bk_title" class="rounded-xl px-3 py-2 w-full" required />
            </div>
            <div><label>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</label><input id="bk_author" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ù…ØªØ±Ø¬Ù…</label><input id="bk_translator" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ø³Ø§Ù„ Ø§Ù†ØªØ´Ø§Ø±</label><input id="bk_published_year" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª</label><input id="bk_pages" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ù…ÙˆØ¶ÙˆØ¹</label><input id="bk_subject" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ ; Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)</label><input id="bk_keywords" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ø§Ù†ØªØ´Ø§Ø±Ø§Øª</label><input id="bk_publisher" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ú©Ø¯/ISBN</label><input id="bk_isbn" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡ *</label><input id="bk_total" type="number" min="1" value="1" class="rounded-xl px-3 py-2 w-full" required /></div>
          </div>
          <div>
            <label>Ø¹Ú©Ø³ Ø¬Ù„Ø¯</label>
            <input id="bk_cover" type="file" accept="image/*" class="block w-full text-sm" />
            <img id="coverPreview" class="mt-3 rounded-xl max-h-48 hidden" />
          </div>
          <div class="md:col-span-3">
            <button class="px-4 py-2 rounded-xl bg-emerald-600">Ø°Ø®ÛŒØ±Ù‡</button>
          </div>
        </form>
        <h3 class="font-bold mb-2">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</h3>
        <div id="adminBooks" class="space-y-3"></div>
      </div>

      <div id="tab-admin-members" class="glass rounded-3xl p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold">Ø§Ø¹Ø¶Ø§</h3>
          <button id="btnAddMember" class="px-3 py-2 rounded-xl bg-slate-600">Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ</button>
        </div>
        <div id="membersList" class="space-y-3"></div>
      </div>

      <div id="tab-admin-loans" class="glass rounded-3xl p-5 hidden">
        <h3 class="font-bold mb-4">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</h3>
        <form id="loanForm" class="grid md:grid-cols-4 gap-4 mb-6">
          <div class="md:col-span-2">
            <label>Ø¹Ø¶Ùˆ</label>
            <input id="loan_member_query" class="rounded-xl px-3 py-2 w-full" placeholder="Ù†Ø§Ù…/Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ/Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ" />
            <div id="loan_member_results" class="mt-2 text-sm"></div>
          </div>
          <div class="md:col-span-2">
            <label>Ú©ØªØ§Ø¨</label>
            <input id="loan_book_query" class="rounded-xl px-3 py-2 w-full" placeholder="Ø¹Ù†ÙˆØ§Ù†/Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡/ISBN" />
            <div id="loan_book_results" class="mt-2 text-sm"></div>
          </div>
          <div>
            <label>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ù‡Ø¬Ø±ÛŒ Ø´Ù…Ø³ÛŒ)</label>
            <input id="loan_due" type="text" class="rounded-xl px-3 py-2 w-full" />
          </div>
          <div class="md:col-span-4"><button class="px-4 py-2 rounded-xl bg-emerald-600">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</button></div>
        </form>
        <h3 class="font-bold mb-2">Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h3>
        <div id="loanList" class="space-y-3"></div>
      </div>

      <div id="tab-admin-import" class="glass rounded-3xl p-5 hidden">
        <h3 class="font-bold mb-4">Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ú©Ø³Ù„/CSV</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-bold mb-2">Ø§Ø¹Ø¶Ø§</h4>
            <input id="fileMembers" type="file" accept=".xlsx,.xls,.csv" />
            <p class="text-xs text-slate-300 mt-2">Ø³ØªÙˆÙ†â€ŒÙ‡Ø§: first_name, last_name, entry_year, degree, student_id, phone, email</p>
            <button id="btnImportMembers" class="mt-3 px-3 py-2 rounded-xl bg-indigo-500">Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ø¹Ø¶Ø§</button>
          </div>
          <div>
            <h4 class="font-bold mb-2">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</h4>
            <input id="fileBooks" type="file" accept=".xlsx,.xls,.csv" />
            <p class="text-xs text-slate-300 mt-2">Ø³ØªÙˆÙ†â€ŒÙ‡Ø§: title*, author, translator, pages, published_year, subject, keywords(Ø¨Ø§ ;), publisher, isbn, total_copies*, cover_url</p>
            <button id="btnImportBooks" class="mt-3 px-3 py-2 rounded-xl bg-indigo-500">Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</button>
          </div>
        </div>
        <hr class="my-6 border-white/10" />
        <h3 class="font-bold mb-2">Ø§Ú©Ø³Ù¾ÙˆØ±Øª CSV</h3>
        <div class="flex flex-wrap gap-2">
          <button id="btnExportBooks" class="px-3 py-2 rounded-xl bg-slate-700">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</button>
          <button id="btnExportMembers" class="px-3 py-2 rounded-xl bg-slate-700">Ø§Ø¹Ø¶Ø§</button>
          <button id="btnExportLoans" class="px-3 py-2 rounded-xl bg-slate-700">Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§</button>
        </div>
      </div>

      <div id="tab-admin-settings" class="glass rounded-3xl p-5 hidden">
        <h3 class="font-bold mb-4">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
        <form id="settingsForm" class="grid md:grid-cols-3 gap-4">
          <div><label>Ù…Ø¯Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù…Ø§Ù†Øª (Ø±ÙˆØ²)</label><input id="st_default_days" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
          <div class="md:col-span-3"><label>Ù„ÙˆÚ¯ÙˆÛŒ Ø³Ø§ÛŒØª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="st_logo" type="file" accept="image/*" /></div>
          <div class="md:col-span-3"><label>Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ø§ÛŒ Ø³Ø§ÛŒØª</label><input id="st_tagline" class="rounded-xl px-3 py-2 w-full" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø³Ø§Ù…Ø§Ù†Ù‡ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú©Ø§Ù†ÙˆÙ†..." /></div>
          <div class="md:col-span-3"><button class="px-4 py-2 rounded-xl bg-emerald-600">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button></div>
        </form>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-400/80">
      Ú©Ø§Ù†ÙˆÙ† Ù…Ù‡Ø¯ÙˆÛŒØª ØµØ¨Ø­ Ø¨Ø§ÙˆØ± â€¢ Ù…Ø¹Ø§ÙˆÙ†Øª ÙØ±Ù‡Ù†Ú¯ÛŒ Ùˆ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ ØµÙ†Ø¹ØªÛŒ Ø§ØµÙÙ‡Ø§Ù†
    </footer>
  </div>

<script>
const SUPABASE_URL = "https://haqocojpgoqiktftdjyw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhcW9jb2pwZ29xaWt0ZnRkanl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MjA4MzIsImV4cCI6MjA3NzI5NjgzMn0.X7PMt1j3wpIBHNfn6RVz_SzDCnqTRZgHtLx0XidsF7Y";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (sel)=> document.querySelector(sel);
const $$ = (sel)=> Array.from(document.querySelectorAll(sel));
const fmtDate = (s)=> new Date(s).toLocaleDateString('fa-IR');
const toast = (msg)=>{ const el=document.createElement('div'); el.className='fixed bottom-4 right-4 bg-black/80 text-white px-3 py-2 rounded-xl text-sm'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3000); };

function toCSV(rows){
  if(!rows || !rows.length) return '';
  const headers = Object.keys(rows[0]);
  const csvRows = [headers.join(',')];
  for(const r of rows){
    const values = headers.map(h=> `"${(r[h]??'').toString().replace(/"/g,'""')}"`);
    csvRows.push(values.join(','));
  }
  return csvRows.join('\n');
}
const download = (filename, content, mime='text/csv')=>{
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
};

let user = null, profile = null;
async function refreshSession(){
  const { data:{ session } } = await supabase.auth.getSession();
  user = session?.user || null;
  if(user){
    const { data: p } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
    profile = p || { id:user.id, full_name:user.email, is_admin:false };
  }
  renderHeader();
}
function renderHeader(){
  const userBox = $('#userBox');
  if(!user || !profile?.is_admin){
    userBox.classList.add('hidden');
    $('#adminShell').classList.add('hidden');
    return;
  }
  userBox.classList.remove('hidden');
  userBox.innerHTML = `
    <span class="chip px-2 py-1 rounded-lg text-xs">Ú©ØªØ§Ø¨Ø¯Ø§Ø±</span>
    <span class="text-sm">${profile?.full_name || user.email}</span>
    <button id="btnSignOut" class="px-3 py-1 rounded-xl bg-rose-600">Ø®Ø±ÙˆØ¬</button>
  `;
  $('#btnSignOut').onclick = async ()=>{ await supabase.auth.signOut(); location.reload(); };
  $('#adminShell').classList.remove('hidden');
  selectTab('admin-books');
  loadAdminBooks(); loadMembers(); loadLoans(); loadSettings();
}

$('#btnAdminAuth').onclick = async () => {
  const email = prompt('Ø§ÛŒÙ…ÛŒÙ„ Ú©ØªØ§Ø¨Ø¯Ø§Ø±:');
  const password = email ? prompt('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:') : null;
  if(!email || !password) return;

  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(!error){ await refreshSession(); return; }

  const needSignup = error.message?.includes('Invalid login credentials') || error.status === 400;
  if(needSignup){
    const { error: e2 } = await supabase.auth.signUp({ email, password });
    if(e2){ toast(e2.message); return; }
    toast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ø› Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø±ÙˆÛŒ Â«ÙˆØ±ÙˆØ¯ Ú©ØªØ§Ø¨Ø¯Ø§Ø±Â» Ø¨Ø²Ù†ÛŒØ¯.');
    return;
  }
  toast(error.message || 'Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯');
};

$$('.tab').forEach(btn=> btn.onclick = ()=> selectTab(btn.dataset.tab));
function selectTab(name){
  ["admin-books","admin-members","admin-loans","admin-import","admin-settings"].forEach(t=> $('#tab-'+t)?.classList.add('hidden'));
  $('#tab-'+name)?.classList.remove('hidden');
  $$('.tab').forEach(b=> b.classList.remove('bg-white/10'));
  document.querySelector(`[data-tab="${name}"]`)?.classList.add('bg-white/10');
}

$('#btnSearch').onclick = ()=> loadCatalog($('#search').value.trim());
async function loadCatalog(q=''){
  let query = supabase.from('books').select('id,title,author,translator,subject,keywords,publisher,isbn,published_year,pages,total_copies,available_copies,cover_url').order('title');
  if(q){
    query = query.or(`title.ilike.%${q}%,author.ilike.%${q}%,translator.ilike.%${q}%,subject.ilike.%${q}%,publisher.ilike.%${q}%,isbn.ilike.%${q}%`);
  }
  const { data, error } = await query;
  if(error) return toast(error.message);
  $('#catalogCount').textContent = (data||[]).length + ' Ú©ØªØ§Ø¨';
  $('#catalogList').innerHTML = (data||[]).map(b=>{
    const available = b.available_copies > 0;
    const kw = Array.isArray(b.keywords) ? b.keywords.filter(Boolean) : ((b.keywords||'').toString().split(';').map(s=>s.trim()).filter(Boolean));
    return `
      <div class="glass rounded-2xl p-4">
        <div class="flex items-start gap-4">
          <img src="${b.cover_url||''}" alt="cover" class="w-20 h-28 object-cover rounded-xl border border-white/10 ${b.cover_url? '' : 'hidden'}"/>
          <div class="flex-1">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-bold">${b.title}</div>
                <div class="text-sm text-slate-300/80">Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: ${b.author||'â€”'} ${b.translator? `â€¢ Ù…ØªØ±Ø¬Ù…: ${b.translator}`:''}</div>
                <div class="text-xs text-slate-400 mt-1">Ø§Ù†ØªØ´Ø§Ø±Ø§Øª: ${b.publisher||'â€”'} ${b.published_year? 'â€¢ Ø³Ø§Ù„ Ø§Ù†ØªØ´Ø§Ø±: '+b.published_year:''} ${b.pages? 'â€¢ ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª: '+b.pages:''} ${b.isbn? 'â€¢ ISBN: '+b.isbn:''}</div>
                ${kw.length? `<div class="mt-2 flex flex-wrap gap-1 text-[11px]">${kw.map(k=>`<span class='chip px-2 py-0.5 rounded-lg'>${k}</span>`).join('')}</div>`:''}
              </div>
              <div class="text-sm flex flex-col items-end gap-2">
                <span class="chip px-2 py-1 rounded-lg ${available? 'text-emerald-300' : 'text-rose-300'}">${available? 'Ù…ÙˆØ¬ÙˆØ¯' : 'Ø§Ù…Ø§Ù†Øª'}</span>
              </div>
            </div>
          </div>
        </div>
      </div>`
  }).join('');
}

const coverInput = $('#bk_cover');
coverInput?.addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const url = URL.createObjectURL(f); $('#coverPreview').src=url; $('#coverPreview').classList.remove('hidden');
});
$('#bookForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const title = $('#bk_title').value.trim();
  if(!title) return toast('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
  const { data: exists } = await supabase.from('books').select('id').ilike('title', title).limit(1);
  if((exists||[]).length){ toast('Ú©ØªØ§Ø¨ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø¹Ù†ÙˆØ§Ù† Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª'); return; }

  let cover_url = null;
  const file = coverInput?.files?.[0];
  if(file){
    const safeName = ('c'+Date.now()+'-'+file.name).replace(/[^a-zA-Z0-9\.\-_]/g,'_');
    const up = await supabase.storage.from('book_covers').upload(safeName, file, { contentType: file.type, upsert: true });
    if(up.error) return toast(up.error.message);
    const pub = supabase.storage.from('book_covers').getPublicUrl(up.data.path); cover_url = pub.data.publicUrl;
  }
  const payload = {
    title,
    author: $('#bk_author').value.trim(),
    translator: $('#bk_translator').value.trim()||null,
    pages: parseInt($('#bk_pages').value,10)||null,
    published_year: parseInt($('#bk_published_year').value,10)||null,
    subject: $('#bk_subject').value.trim()||null,
    keywords: ($('#bk_keywords').value||'').split(';').map(s=>s.trim()).filter(Boolean),
    publisher: $('#bk_publisher').value.trim()||null,
    isbn: $('#bk_isbn').value.trim()||null,
    total_copies: parseInt($('#bk_total').value,10)||1,
    available_copies: parseInt($('#bk_total').value,10)||1,
    cover_url
  };
  const { error } = await supabase.from('books').insert(payload);
  if(error) return toast(error.message);
  toast('Ú©ØªØ§Ø¨ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
  ['#bk_title','#bk_author','#bk_translator','#bk_pages','#bk_published_year','#bk_subject','#bk_keywords','#bk_publisher','#bk_isbn'].forEach(s=> $(s).value='');
  $('#bk_total').value = 1; $('#bk_cover').value=''; $('#coverPreview').classList.add('hidden');
  loadCatalog(); loadAdminBooks();
});
async function loadAdminBooks(){
  const { data, error } = await supabase.from('books').select('*').order('created_at', { ascending:false });
  if(error) return toast(error.message);
  $('#adminBooks').innerHTML = (data||[]).map(b=>`
    <div class="glass rounded-2xl p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="${b.cover_url||''}" class="w-12 h-16 object-cover rounded-lg border border-white/10 ${b.cover_url? '': 'hidden'}"/>
        <div>
          <div class="font-bold">${b.title}</div>
          <div class="text-xs text-slate-400">Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: ${b.author||'â€”'} ${b.translator? 'â€¢ Ù…ØªØ±Ø¬Ù…: '+b.translator:''} â€¢ Ø§Ù†ØªØ´Ø§Ø±Ø§Øª: ${b.publisher||'â€”'} â€¢ Ø³Ø§Ù„: ${b.published_year||'â€”'}</div>
        </div>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span class="chip px-2 py-1 rounded-lg">Ù…ÙˆØ¬ÙˆØ¯: ${b.available_copies}/${b.total_copies}</span>
        <button class="px-3 py-1 rounded-lg bg-slate-600" onclick='editBook(${JSON.stringify(b).replaceAll("'","&#39;")})'>ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="px-3 py-1 rounded-lg bg-rose-600" onclick="deleteBook(${b.id})">Ø­Ø°Ù</button>
      </div>
    </div>`).join('');
}
async function deleteBook(id){
  if(!confirm('Ú©ØªØ§Ø¨ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  const { error } = await supabase.from('books').delete().eq('id', id);
  if(error) return toast(error.message);
  toast('Ø­Ø°Ù Ø´Ø¯'); loadCatalog(); loadAdminBooks();
}
async function editBook(b){ /* replaced by modal version */ return window.editBook(b); }

async function loadMembers(){
  const { data, error } = await supabase.from('members').select('*').order('last_name');
  if(error) return toast(error.message);
  $('#membersList').innerHTML = (data||[]).map(m=>`
    <div class="glass rounded-2xl p-4 flex items-center justify-between">
      <div>
        <div class="font-bold">${m.first_name||''} ${m.last_name||''}</div>
        <div class="text-xs text-slate-400">${m.degree||''} â€¢ ${m.entry_year||''} â€¢ ${m.student_id||''} â€¢ ${m.email||''} â€¢ ${m.phone||''}</div>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <button class="px-3 py-1 rounded-lg bg-slate-600" onclick='editMember(${JSON.stringify(m).replaceAll("'","&#39;")})'>ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="px-3 py-1 rounded-lg bg-rose-600" onclick="deleteMember(${m.id})">Ø­Ø°Ù</button>
      </div>
    </div>`).join('');
}
async function editMember(m){ /* replaced by modal version */ return window.editMember(m); }
async function deleteMember(id){
  if(!confirm('Ø¹Ø¶Ùˆ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  const { error } = await supabase.from('members').delete().eq('id', id);
  if(error) return toast(error.message); toast('Ø­Ø°Ù Ø´Ø¯'); loadMembers();
}

$('#loanForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const memberId = $('#loan_member_results')?.dataset.sel;
  const bookId = $('#loan_book_results')?.dataset.sel;
  if(!memberId || !bookId) { toast('Ø¹Ø¶Ùˆ Ùˆ Ú©ØªØ§Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }

  let due_at_iso;
  const dueStr = $('#loan_due').value?.trim();
  if (dueStr) {
    try {
      const parts = dueStr.replaceAll('-', '/').split('/').map(x=>parseInt(x,10));
      const pd = new persianDate([parts[0], parts[1], parts[2]]).toGregorian();
      const g = new Date(pd[0], pd[1]-1, pd[2], 12, 0, 0);
      due_at_iso = g.toISOString();
    } catch(e){}
  }
  if(!due_at_iso){
    const { data: st } = await supabase.from('settings').select('default_loan_days').eq('id',1).maybeSingle();
    const days = st?.default_loan_days || 14;
    due_at_iso = new Date(Date.now() + days*24*3600*1000).toISOString();
  }

  const { data: loan, error } = await supabase.rpc('issue_loan', {
    p_book_id: parseInt(bookId, 10),
    p_member_id: parseInt(memberId, 10),
    p_admin_id: user.id,
    p_due_at: due_at_iso
  });
  if (error) { toast(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª'); return; }
  toast('Ø§Ù…Ø§Ù†Øª Ø«Ø¨Øª Ø´Ø¯');
  loadCatalog(); loadLoans();
});

$('#loan_member_query')?.addEventListener('input', async (e)=>{
  const q = e.target.value.trim(); if(!q){ $('#loan_member_results').innerHTML=''; $('#loan_member_results').dataset.sel=''; return; }
  let { data } = await supabase.from('members').select('id,first_name,last_name,student_id').or(`first_name.ilike.%${q}%,last_name.ilike.%${q}%,student_id.ilike.%${q}%`).limit(8);
  $('#loan_member_results').innerHTML = (data||[]).map(m=>`<button class='chip px-2 py-1 rounded-lg mr-1 mb-1' data-id='${m.id}'>${m.first_name||''} ${m.last_name||''} â€¢ ${m.student_id||''}</button>`).join('');
  $$('#loan_member_results button').forEach(b=> b.onclick = ()=>{ $('#loan_member_results').dataset.sel=b.dataset.id; toast('Ø¹Ø¶Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯'); });
});
$('#loan_book_query')?.addEventListener('input', async (e)=>{
  const q = e.target.value.trim(); if(!q){ $('#loan_book_results').innerHTML=''; $('#loan_book_results').dataset.sel=''; return; }
  let { data } = await supabase.from('books').select('id,title,author,isbn,available_copies').or(`title.ilike.%${q}%,author.ilike.%${q}%,isbn.ilike.%${q}%`).gte('available_copies',1).limit(8);
  $('#loan_book_results').innerHTML = (data||[]).map(b=>`<button class='chip px-2 py-1 rounded-lg mr-1 mb-1' data-id='${b.id}'>${b.title} ${b.author? 'â€¢ '+b.author:''} ${b.isbn? 'â€¢ '+b.isbn:''}</button>`).join('');
  $$('#loan_book_results button').forEach(b=> b.onclick = ()=>{ $('#loan_book_results').dataset.sel=b.dataset.id; toast('Ú©ØªØ§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯'); });
});

async function loadLoans(){
  const { data, error } = await supabase.from('loans').select('id,borrowed_at,due_at,returned_at, renewals_count, members:member_id(first_name,last_name), books:book_id(title), admins:issued_by_admin_id(full_name)').is('returned_at', null).order('borrowed_at',{ascending:false});
  if(error) return toast(error.message);
  $('#loanList').innerHTML = (data||[]).map(l=>`
    <div class="glass rounded-2xl p-4 space-y-2">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-bold">${l.books?.title||'â€”'}</div>
          <div class="text-xs text-slate-300">Ù…Ø³Ø¦ÙˆÙ„: ${l.admins?.full_name||'â€”'} â€¢ Ø§Ù…Ø§Ù†Øªâ€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡: ${(l.members?.first_name||'')+' '+(l.members?.last_name||'')}</div>
          <div class="text-xs text-slate-400">ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª: ${fmtDate(l.borrowed_at)} â€¢ Ø³Ø±Ø±Ø³ÛŒØ¯: ${fmtDate(l.due_at)} â€¢ ØªÙ…Ø¯ÛŒØ¯Ù‡Ø§: ${l.renewals_count ?? 0}</div>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-1 rounded-lg bg-slate-600" onclick="editLoan(${l.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
          <button class="px-3 py-1 rounded-lg bg-amber-600" onclick="returnLoan(${l.id})">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
      </div>
    </div>`).join('');
}
async function editLoan(id){
  const { data: l, error } = await supabase.from('loans').select('*').eq('id', id).maybeSingle();
  if(error || !l) { toast('ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
  const b = prompt('ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª (YYYY/MM/DD - Ø´Ù…Ø³ÛŒ)', new persianDate(new Date(l.borrowed_at)).format('YYYY/MM/DD'));
  const d = prompt('ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (YYYY/MM/DD - Ø´Ù…Ø³ÛŒ)', new persianDate(new Date(l.due_at)).format('YYYY/MM/DD'));
  const r = parseInt(prompt('ØªØ¹Ø¯Ø§Ø¯ ØªÙ…Ø¯ÛŒØ¯Ù‡Ø§', l.renewals_count ?? 0) || '0', 10);
  let borrowed_at = l.borrowed_at, due_at = l.due_at;
  try{ const pb = new persianDate(b.split('/').map(Number)).toGregorian(); borrowed_at = new Date(pb[0], pb[1]-1, pb[2], 12, 0, 0).toISOString(); }catch(e){}
  try{ const pd = new persianDate(d.split('/').map(Number)).toGregorian(); due_at = new Date(pd[0], pd[1]-1, pd[2], 12, 0, 0).toISOString(); }catch(e){}
  const { error: e2 } = await supabase.from('loans').update({ borrowed_at, due_at, renewals_count: r }).eq('id', id);
  if(e2) return toast(e2.message); toast('Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯'); loadLoans();
}
async function returnLoan(id){
  const { data, error } = await supabase.rpc('return_loan', { p_loan_id: id });
  if (error) { toast(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¨Ø§Ø²Ú¯Ø´Øª'); return; }
  toast('Ø¨Ø§Ø²Ú¯Ø´Øª Ø«Ø¨Øª Ø´Ø¯'); loadCatalog(); loadLoans();
}

async function readSheet(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e=>{ const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws, {defval:''}); resolve(rows); };
    reader.onerror = reject; reader.readAsArrayBuffer(file);
  });
}
$('#btnImportMembers')?.addEventListener('click', async ()=>{
  const f = $('#fileMembers').files?.[0]; if(!f) return toast('ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
  const rows = await readSheet(f);
  const mapped = rows.map(r=>({
    first_name: r.first_name||r['first name']||r['Ù†Ø§Ù…']||null,
    last_name: r.last_name||r['last name']||r['Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ']||null,
    entry_year: parseInt(r.entry_year||r['entry year']||r['Ø³Ø§Ù„ ÙˆØ±ÙˆØ¯'])||null,
    degree: r.degree||r['Ù…Ù‚Ø·Ø¹']||null,
    student_id: (r.student_id||r['student id']||r['Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ']||'').toString()||null,
    phone: (r.phone||r['Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†']||'').toString()||null,
    email: r.email||r['Ø§ÛŒÙ…ÛŒÙ„']||null,
  }));
  const valid = mapped.filter(m=> m.first_name || m.last_name || m.student_id || m.email);
  if(!valid.length) return toast('Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
  const { error } = await supabase.from('members').insert(valid);
  if(error) return toast(error.message); toast('Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ø¹Ø¶Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); loadMembers();
});
$('#btnImportBooks')?.addEventListener('click', async ()=>{
  const f = $('#fileBooks').files?.[0]; if(!f) return toast('ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
  const rows = await readSheet(f);
  const mapped = rows.map(r=>({
    title: r.title||r['Ø¹Ù†ÙˆØ§Ù†']||'',
    author: r.author||r['Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡']||null,
    translator: r.translator||r['Ù…ØªØ±Ø¬Ù…']||null,
    pages: parseInt(r.pages||r['ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª'])||null,
    published_year: parseInt(r.published_year||r['Ø³Ø§Ù„ Ø§Ù†ØªØ´Ø§Ø±'])||null,
    subject: r.subject||r['Ù…ÙˆØ¶ÙˆØ¹']||null,
    keywords: ((r.keywords||r['Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§']||'')+'').split(';').map(s=>s.trim()).filter(Boolean),
    publisher: r.publisher||r['Ø§Ù†ØªØ´Ø§Ø±Ø§Øª']||null,
    isbn: r.isbn||r['ISBN']||null,
    total_copies: parseInt(r.total_copies||r['ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡'])||1,
    available_copies: parseInt(r.total_copies||r['ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡'])||1,
    cover_url: r.cover_url||null
  }));
  const valid = mapped.filter(b=> b.title);
  if(!valid.length) return toast('Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
  const { error } = await supabase.from('books').insert(valid);
  if(error) return toast(error.message); toast('Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); loadCatalog(); loadAdminBooks();
});
$('#btnExportBooks')?.addEventListener('click', async ()=>{ const { data } = await supabase.from('books').select('*'); download('books.csv', toCSV(data||[])); });
$('#btnExportMembers')?.addEventListener('click', async ()=>{ const { data } = await supabase.from('members').select('*'); download('members.csv', toCSV(data||[])); });
$('#btnExportLoans')?.addEventListener('click', async ()=>{ const { data } = await supabase.from('loans').select('id,book_id,member_id,borrowed_at,due_at,returned_at,renewals_count'); download('loans.csv', toCSV(data||[])); });

async function loadSettings(){
  const { data } = await supabase.from('settings').select('*').eq('id',1).maybeSingle();
  $('#st_default_days').value = data?.default_loan_days ?? 14;
  $('#st_tagline').value = data?.tagline || '';
  if (data?.logo_url) { document.getElementById('logo').src = data.logo_url; document.getElementById('logo').classList.remove('hidden'); document.getElementById('logoFallback').classList.add('hidden'); }
  if (data?.tagline) { document.getElementById('tagline').textContent = data.tagline; }
}
$('#settingsForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  let logo_url = null;
  const file = document.getElementById('st_logo').files?.[0];
  if(file){
    const safe = ('logo-'+Date.now()+'-'+file.name).replace(/[^a-zA-Z0-9\.\-_]/g,'_');
    const up = await supabase.storage.from('book_covers').upload(safe, file, { contentType: file.type, upsert: true });
    if(up.error){ toast(up.error.message); return; }
    const pub = supabase.storage.from('book_covers').getPublicUrl(up.data.path); logo_url = pub.data.publicUrl;
  }
  const payload = {
    id: 1,
    default_loan_days: parseInt(document.getElementById('st_default_days').value,10)||14,
    tagline: document.getElementById('st_tagline').value || null,
  };
  if(logo_url) payload.logo_url = logo_url;
  const { error } = await supabase.from('settings').upsert(payload, { onConflict: 'id' });
  if(error) return toast(error.message);
  toast('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
  loadSettings();
});

loadCatalog();
loadSettings();
refreshSession();

// === Helpers: Modals ===
function openModal(id){ const el=document.getElementById(id); if(!el) return; el.classList.remove('hidden'); el.classList.add('flex'); }
function closeModal(id){ const el=document.getElementById(id); if(!el) return; el.classList.add('hidden'); el.classList.remove('flex'); }

// === Datepicker init ===
function initPersianPicker(selector){
  if (typeof $ === 'function' && typeof $.fn !== 'undefined' && $.fn.persianDatepicker){
    $(selector).persianDatepicker({ format: 'YYYY/MM/DD', initialValue: false, autoClose: true });
  }
}

// Init loan due picker on page
document.addEventListener('DOMContentLoaded', ()=>{
  initPersianPicker('#loan_due');
});

// === Book edit via modal ===
let CURRENT_BOOK = null;
async function editBook(b){ /* replaced by modal version */ return window.editBook(b); }

document.getElementById('formBookModal')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = parseInt(document.getElementById('mb_id').value, 10);
  const payload = {
    title: document.getElementById('mb_title').value.trim(),
    author: document.getElementById('mb_author').value.trim() || null,
    translator: document.getElementById('mb_translator').value.trim() || null,
    published_year: parseInt(document.getElementById('mb_published_year').value,10) || null,
    pages: parseInt(document.getElementById('mb_pages').value,10) || null,
    subject: document.getElementById('mb_subject').value.trim() || null,
    keywords: (document.getElementById('mb_keywords').value||'').split(';').map(s=>s.trim()).filter(Boolean),
    publisher: document.getElementById('mb_publisher').value.trim() || null,
    isbn: document.getElementById('mb_isbn').value.trim() || null,
    total_copies: parseInt(document.getElementById('mb_total_copies').value,10) || 1
  };
  const { error } = await supabase.from('books').update(payload).eq('id', id);
  if(error){ toast(error.message); return; }
  toast('ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯');
  closeModal('modalBook'); loadCatalog(); loadAdminBooks();
});

// === Member add/edit via modal ===
function openAddMember(){
  document.getElementById('modalMemberTitle').textContent = 'Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ';
  document.getElementById('mm_id').value = '';
  ['mm_first_name','mm_last_name','mm_entry_year','mm_degree','mm_student_id','mm_phone','mm_email'].forEach(id=> document.getElementById(id).value='');
  openModal('modalMember');
}
async function editMember(m){ /* replaced by modal version */ return window.editMember(m); }

document.getElementById('formMemberModal')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('mm_id').value;
  const payload = {
    first_name: document.getElementById('mm_first_name').value.trim() || null,
    last_name: document.getElementById('mm_last_name').value.trim() || null,
    entry_year: parseInt(document.getElementById('mm_entry_year').value,10) || null,
    degree: document.getElementById('mm_degree').value.trim() || null,
    student_id: document.getElementById('mm_student_id').value.trim() || null,
    phone: document.getElementById('mm_phone').value.trim() || null,
    email: document.getElementById('mm_email').value.trim() || null,
  };
  if(id){
    const { error } = await supabase.from('members').update(payload).eq('id', parseInt(id,10));
    if(error){ toast(error.message); return; }
    toast('ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯');
  }else{
    const { error } = await supabase.from('members').insert(payload);
    if(error){ toast(error.message); return; }
    toast('Ø¹Ø¶Ùˆ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
  }
  closeModal('modalMember'); loadMembers();
});

// Replace "Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ" button handler
document.getElementById('btnAddMember')?.addEventListener('click', openAddMember);

// === Loan edit via modal & datepickers ===
async function editLoan(id){
  const { data: l, error } = await supabase.from('loans').select('*').eq('id', id).maybeSingle();
  if(error || !l){ toast('ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
  document.getElementById('ml_id').value = l.id;
  // Pre-fill Persian dates
  try{
    document.getElementById('ml_borrowed').value = new persianDate(new Date(l.borrowed_at)).format('YYYY/MM/DD');
  }catch(e){ document.getElementById('ml_borrowed').value=''; }
  try{
    document.getElementById('ml_due').value = new persianDate(new Date(l.due_at)).format('YYYY/MM/DD');
  }catch(e){ document.getElementById('ml_due').value=''; }
  document.getElementById('ml_renewals').value = (l.renewals_count ?? 0);
  openModal('modalLoan');
  initPersianPicker('#ml_borrowed'); initPersianPicker('#ml_due');
}

document.getElementById('formLoanModal')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = parseInt(document.getElementById('ml_id').value,10);
  const b = document.getElementById('ml_borrowed').value.trim();
  const d = document.getElementById('ml_due').value.trim();
  const r = parseInt(document.getElementById('ml_renewals').value,10) || 0;
  let borrowed_at = null, due_at = null;
  try{ const pb = new persianDate(b.split('/').map(Number)).toGregorian(); borrowed_at = new Date(pb[0], pb[1]-1, pb[2], 12, 0, 0).toISOString(); }catch(e){}
  try{ const pd = new persianDate(d.split('/').map(Number)).toGregorian(); due_at = new Date(pd[0], pd[1]-1, pd[2], 12, 0, 0).toISOString(); }catch(e){}
  const payload = { renewals_count: r };
  if(borrowed_at) payload.borrowed_at = borrowed_at;
  if(due_at) payload.due_at = due_at;
  const { error } = await supabase.from('loans').update(payload).eq('id', id);
  if(error){ toast(error.message); return; }
  toast('Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯'); closeModal('modalLoan'); loadLoans();
});


</script>

  <!-- === Modals === -->
  <!-- Book Modal -->
  <div id="modalBook" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="bg-slate-800 rounded-2xl p-5 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold" id="modalBookTitle">ÙˆÛŒØ±Ø§ÛŒØ´ Ú©ØªØ§Ø¨</h3>
        <button class="px-2 py-1 rounded-lg bg-slate-700" onclick="closeModal('modalBook')">âœ•</button>
      </div>
      <form id="formBookModal" class="grid md:grid-cols-3 gap-4">
        <input type="hidden" id="mb_id" />
        <div class="md:col-span-3"><label>Ø¹Ù†ÙˆØ§Ù† *</label><input id="mb_title" class="rounded-xl px-3 py-2 w-full" required /></div>
        <div><label>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</label><input id="mb_author" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ù…ØªØ±Ø¬Ù…</label><input id="mb_translator" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ø³Ø§Ù„ Ø§Ù†ØªØ´Ø§Ø±</label><input id="mb_published_year" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª</label><input id="mb_pages" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-3"><label>Ù…ÙˆØ¶ÙˆØ¹</label><input id="mb_subject" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-3"><label>Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ ; Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)</label><input id="mb_keywords" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2"><label>Ø§Ù†ØªØ´Ø§Ø±Ø§Øª</label><input id="mb_publisher" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ú©Ø¯/ISBN</label><input id="mb_isbn" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡</label><input id="mb_total_copies" type="number" min="1" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-3 mt-2">
          <button class="px-4 py-2 rounded-xl bg-emerald-600" type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Member Modal -->
  <div id="modalMember" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="bg-slate-800 rounded-2xl p-5 w-full max-w-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold" id="modalMemberTitle">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø¶Ùˆ</h3>
        <button class="px-2 py-1 rounded-lg bg-slate-700" onclick="closeModal('modalMember')">âœ•</button>
      </div>
      <form id="formMemberModal" class="grid md:grid-cols-2 gap-4">
        <input type="hidden" id="mm_id" />
        <div><label>Ù†Ø§Ù…</label><input id="mm_first_name" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label><input id="mm_last_name" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ø³Ø§Ù„ ÙˆØ±ÙˆØ¯</label><input id="mm_entry_year" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ù…Ù‚Ø·Ø¹ ØªØ­ØµÛŒÙ„ÛŒ</label><input id="mm_degree" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ</label><input id="mm_student_id" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</label><input id="mm_phone" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2"><label>Ø§ÛŒÙ…ÛŒÙ„</label><input id="mm_email" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2 mt-2">
          <button class="px-4 py-2 rounded-xl bg-emerald-600" type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loan Modal -->
  <div id="modalLoan" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="bg-slate-800 rounded-2xl p-5 w-full max-w-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold">ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù…Ø§Ù†Øª</h3>
        <button class="px-2 py-1 rounded-lg bg-slate-700" onclick="closeModal('modalLoan')">âœ•</button>
      </div>
      <form id="formLoanModal" class="grid md:grid-cols-2 gap-4">
        <input type="hidden" id="ml_id" />
        <div><label>ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª (Ù‡Ø¬Ø±ÛŒ Ø´Ù…Ø³ÛŒ)</label><input id="ml_borrowed" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ù‡Ø¬Ø±ÛŒ Ø´Ù…Ø³ÛŒ)</label><input id="ml_due" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2"><label>ØªØ¹Ø¯Ø§Ø¯ ØªÙ…Ø¯ÛŒØ¯Ù‡Ø§</label><input id="ml_renewals" type="number" min="0" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2 mt-2">
          <button class="px-4 py-2 rounded-xl bg-emerald-600" type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </form>
    </div>
  </div>


<script>
/* ===================== JALALI DATE UTIL & PICKER (no deps) ===================== */
(function(){
  // --- Convertors (Gregorian <-> Jalali) ---
  function div(a,b){return Math.floor(a/b);}
  function gregorian_to_jalali(gy, gm, gd){
    var g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334];
    var jy=(gy<=1600)?0:979; gy-=(gy<=1600)?621:1600;
    var gy2=(gm>2)?(gy+1):gy;
    var days=365*gy+div(gy2+3,4)-div(gy2+99,100)+div(gy2+399,400)-80+gd+g_d_m[gm-1];
    jy+=33*div(days,12053); days%=12053;
    jy+=4*div(days,1461); days%=1461;
    if(days>365){jy+=div(days-1,365); days=(days-1)%365;}
    var jm=(days<186)?1+div(days,31):7+div(days-186,30);
    var jd=1+((days<186)?(days%31):((days-186)%30));
    return [jy+1,jm,jd];
  }
  function jalali_to_gregorian(jy,jm,jd){
    jy-=979; var days=365*jy+div(jy,33)*8+div((jy%33)+3,4)+jd-1;
    for(var i=1;i<jm;i++) days+=(i<7)?31:30;
    var gy=1600+400*div(days,146097); days%=146097;
    var leap=true;
    if(days>=36525){days--; gy+=100*div(days,36524); days%=36524; if(days>=365) days++; else leap=false;}
    gy+=4*div(days,1461); days%=1461;
    if(days>=366){leap=false; days--; gy+=div(days,365); days%=365;}
    var gd=days+1; var sal_a=[0,31,(leap?29:28),31,30,31,30,31,31,30,31,30,31];
    var gm=0; for(gm=1; gm<=12 && gd>sal_a[gm]; gm++) gd-=sal_a[gm];
    return [gy,gm,gd];
  }
  function pad(n){return (n<10?'0':'')+n;}
  function toJalaliString(d){
    var j=gregorian_to_jalali(d.getFullYear(), d.getMonth()+1, d.getDate());
    return j[0]+"/"+pad(j[1])+"/"+pad(j[2]);
  }
  function fromJalaliString(s){
    var a=s.split('/').map(Number);
    if(a.length<3) return null;
    var g=jalali_to_gregorian(a[0],a[1],a[2]);
    return new Date(g[0], g[1]-1, g[2], 12, 0, 0);
  }

  // --- Lightweight picker UI ---
  function buildCalendar(input, valueDate){
    var wrapper=document.createElement('div');
    wrapper.className='absolute z-50 bg-slate-800 text-slate-100 rounded-xl shadow-xl p-3 border border-white/10';
    wrapper.style.minWidth='260px';
    wrapper.style.direction='rtl';
    wrapper.style.fontSize='12px';

    var picked=valueDate||new Date();
    var j=gregorian_to_jalali(picked.getFullYear(), picked.getMonth()+1, picked.getDate());
    var jy=j[0], jm=j[1];

    function render(){
      wrapper.innerHTML='';
      var header=document.createElement('div');
      header.className='flex items-center justify-between mb-2';
      var prev=document.createElement('button'); prev.textContent='â€¹'; prev.className='px-2 py-1 bg-white/10 rounded';
      var title=document.createElement('div'); title.className='font-bold';
      var next=document.createElement('button'); next.textContent='â€º'; next.className='px-2 py-1 bg-white/10 rounded';
      title.textContent=''+jy+' / '+pad(jm);
      prev.onclick=function(){ jm--; if(jm<1){ jm=12; jy--; } drawDays(); };
      next.onclick=function(){ jm++; if(jm>12){ jm=1; jy++; } drawDays(); };
      header.append(prev,title,next);
      wrapper.appendChild(header);
      var grid=document.createElement('div'); grid.className='grid grid-cols-7 gap-1';
      var wnames=['Ø´','ÛŒ','Ø¯','Ø³','Ú†','Ù¾','Ø¬'];
      wnames.forEach(function(w){ var c=document.createElement('div'); c.textContent=w; c.className='text-center text-slate-300'; grid.appendChild(c); });
      function daysInJalaliMonth(y,m){ return (m<=6)?31: (m<=11?30: (( ( ( ( (y%33)===1)||(y%33)===5||(y%33)===9||(y%33)===13||(y%33)===17||(y%33)===22||(y%33)===26||(y%33)===30 ) ) )?30:29)); }
      function dayOfWeekJalali(y,m,day){
        var g=jalali_to_gregorian(y,m,1);
        var d=new Date(g[0], g[1]-1, 1).getDay(); // 0=Sun
        // convert to Sat-first index
        return (d+1)%7;
      }
      function drawDays(){
        render();
      }
      // compute first week offset & number of days
      var offset=dayOfWeekJalali(jy,jm,1);
      for(var i=0;i<offset;i++){ var e=document.createElement('div'); e.innerHTML='&nbsp;'; grid.appendChild(e); }
      var dim=daysInJalaliMonth(jy,jm);
      for(var d=1; d<=dim; d++){
        var btn=document.createElement('button');
        btn.className='px-2 py-1 rounded hover:bg-white/10 text-center';
        btn.textContent=pad(d);
        btn.onclick=function(ev){
          var day=parseInt(this.textContent,10);
          var g=jalali_to_gregorian(jy,jm,day);
          var dt=new Date(g[0], g[1]-1, g[2], 12,0,0);
          input.value = toJalaliString(dt);
          input.dataset.iso = dt.toISOString();
          wrapper.remove();
          input.dispatchEvent(new Event('change'));
        };
        grid.appendChild(btn);
      }
      wrapper.appendChild(grid);
    }
    render();
    return wrapper;
  }

  function attachPicker(input){
    if(input.dataset.jalaliBound==='1') return;
    input.dataset.jalaliBound='1';
    input.readOnly=true;
    input.addEventListener('focus', function(){
      var rect=input.getBoundingClientRect();
      var existing=document.getElementById('jalali-picker-popup');
      if(existing) existing.remove();
      var cal=buildCalendar(input, input.dataset.iso? new Date(input.dataset.iso) : new Date());
      cal.id='jalali-picker-popup';
      cal.style.position='fixed';
      cal.style.top=(rect.bottom+6)+'px';
      cal.style.left=(rect.left)+'px';
      document.body.appendChild(cal);
    });
  }

  // Expose helpers globally
  window.JalaliUtil = { toJalaliString, fromJalaliString, gregorian_to_jalali, jalali_to_gregorian };
  window.attachJalaliPicker = attachPicker;
})();
/* ===================== END: JALALI PICKER ===================== */

// ===================== LOANS UI REWRITE =====================
(async function(){
  function $(s){return document.querySelector(s);}
  function $all(s){return Array.from(document.querySelectorAll(s));}
  const supa = window.supabase;

  // Replace Loans tab content entirely with our layout
  document.addEventListener('DOMContentLoaded', async function(){
    const host = document.getElementById('tab-admin-loans');
    if(!host) return;
    host.innerHTML = `
      <div class="glass rounded-2xl p-5">
        <div class="text-lg font-bold mb-4">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-slate-300">Ú©ØªØ§Ø¨</label>
            <input id="loan_book" class="rounded-xl px-3 py-2 w-full" placeholder="Ø¹Ù†ÙˆØ§Ù†/Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡/ISBN"/>
          </div>
          <div>
            <label class="text-sm text-slate-300">Ø¹Ø¶Ùˆ</label>
            <input id="loan_member" class="rounded-xl px-3 py-2 w-full" placeholder="Ù†Ø§Ù…/Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ/Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ"/>
          </div>
          <div>
            <label class="text-sm text-slate-300">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª (Ø¬Ù„Ø§Ù„ÛŒ)</label>
            <input id="loan_borrowed_j" class="rounded-xl px-3 py-2 w-full" placeholder="YYYY/MM/DD"/>
          </div>
          <div>
            <label class="text-sm text-slate-300">ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ø¬Ù„Ø§Ù„ÛŒ)</label>
            <input id="loan_due_j" class="rounded-xl px-3 py-2 w-full" placeholder="YYYY/MM/DD"/>
          </div>
        </div>
        <div class="mt-4">
          <button id="btn_issue_loan" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</button>
        </div>
      </div>

      <div class="mt-8">
        <div id="overdueBox" class="hidden">
          <div class="text-amber-300 font-bold mb-2">Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚ (Ù…Ù‡Ù„Øª Ú¯Ø°Ø´ØªÙ‡)</div>
          <div id="loanListOverdue" class="space-y-2"></div>
          <hr class="my-4 border-white/10"/>
        </div>
        <div class="flex items-center justify-between mb-2">
          <div class="text-lg font-bold">Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</div>
          <button id="refreshLoans" class="px-3 py-1 rounded bg-white/10">Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ</button>
        </div>
        <div id="loanList" class="space-y-2"></div>
      </div>
    `;

    // init defaults for dates
    const today = new Date();
    $('#loan_borrowed_j').value = JalaliUtil.toJalaliString(today);
    const { data: setRow } = await supa.from('settings').select('default_loan_days').limit(1).maybeSingle();
    const addDays = (setRow && setRow.default_loan_days) ? setRow.default_loan_days : 14;
    const due = new Date(today.getTime()+ addDays*24*3600*1000);
    $('#loan_due_j').value = JalaliUtil.toJalaliString(due);

    // attach Jalali pickers
    attachJalaliPicker($('#loan_borrowed_j'));
    attachJalaliPicker($('#loan_due_j'));

    // wire actions
    $('#btn_issue_loan').onclick = issueLoan;
    $('#refreshLoans').onclick = loadLoans;

    // initial load
    loadLoans();
  });

  async function findBookIdByQuery(q){
    const { data } = await supa.from('books').select('id').or(`title.ilike.%${q}%,author.ilike.%${q}%,isbn.ilike.%${q}%`).limit(1);
    return data && data[0] ? data[0].id : null;
  }
  async function findMemberIdByQuery(q){
    const { data } = await supa.from('members').select('id').or(`first_name.ilike.%${q}%,last_name.ilike.%${q}%,student_id.ilike.%${q}%`).limit(1);
    return data && data[0] ? data[0].id : null;
  }

  async function issueLoan(){
    const qBook = $('#loan_book').value.trim();
    const qMem  = $('#loan_member').value.trim();
    if(!qBook || !qMem) return toast('Ú©ØªØ§Ø¨ Ùˆ Ø¹Ø¶Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    const book_id = await findBookIdByQuery(qBook);
    const member_id = await findMemberIdByQuery(qMem);
    if(!book_id || !member_id) return toast('Ú©ØªØ§Ø¨ ÛŒØ§ Ø¹Ø¶Ùˆ ÛŒØ§ÙØª Ù†Ø´Ø¯');

    const borrowed_at = JalaliUtil.fromJalaliString($('#loan_borrowed_j').value);
    const due_at = JalaliUtil.fromJalaliString($('#loan_due_j').value);
    if(!borrowed_at || !due_at) return toast('ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');

    const user = (await supa.auth.getUser()).data.user;
    const { error } = await supa.from('loans').insert({
      book_id, member_id, issued_by_admin_id: user?.id || null,
      borrowed_at: borrowed_at.toISOString(), due_at: due_at.toISOString()
    });
    if(error) return toast(error.message);
    toast('Ø§Ù…Ø§Ù†Øª Ø«Ø¨Øª Ø´Ø¯');
    loadLoans();
  }

  window.returnLoan = async function(id){
    const { error } = await supa.rpc('return_loan', { p_loan_id: id });
    if(error) return toast(error.message);
    toast('Ø¨Ø§Ø²Ú¯Ø´Øª Ø«Ø¨Øª Ø´Ø¯'); loadLoans();
  };

  window.editLoan = async function(id){
    const { data: l, error } = await supa.from('loans').select('*').eq('id', id).maybeSingle();
    if(error || !l) return toast('ÛŒØ§ÙØª Ù†Ø´Ø¯');
    openLoanEditModal(l);
  };

  window.renewLoan = async function(id){
    const { data: l, error } = await supa.from('loans').select('*').eq('id', id).maybeSingle();
    if(error || !l) return toast('ÛŒØ§ÙØª Ù†Ø´Ø¯');
    const base = new Date(l.due_at||Date.now());
    const def = new Date(base.getTime()+7*24*3600*1000); // Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÛŒÚ© Ù‡ÙØªÙ‡
    openLoanEditModal(l, { renew:true, dueDefault: def });
  };

  function openLoanEditModal(l, opts={}){
    const isRenew=!!opts.renew;
    const w=document.createElement('div'); w.className='fixed inset-0 z-50 bg-black/50 flex items-center justify-center';
    w.innerHTML=`
      <div class="glass rounded-2xl p-5 w-[520px] max-w-[92vw]">
        <div class="flex items-center justify-between mb-3">
          <div class="font-bold">${isRenew?'ØªÙ…Ø¯ÛŒØ¯ Ø§Ù…Ø§Ù†Øª':'ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù…Ø§Ù†Øª'}</div>
          <button class="px-2 py-1 bg-white/10 rounded" onclick="this.closest('.fixed').remove()">âœ•</button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-300">ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª (Ø¬Ù„Ø§Ù„ÛŒ)</label>
            <input id="ed_borrowed" class="rounded-xl px-3 py-2 w-full"/>
          </div>
          <div>
            <label class="text-xs text-slate-300">ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ø¬Ù„Ø§Ù„ÛŒ)</label>
            <input id="ed_due" class="rounded-xl px-3 py-2 w-full"/>
          </div>
        </div>
        <div class="mt-3">
          <label class="text-xs text-slate-300">Ø¹Ø¶Ùˆ</label>
          <input id="ed_member" class="rounded-xl px-3 py-2 w-full" placeholder="Ù†Ø§Ù…/Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ/Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ"/>
        </div>
        <div class="mt-4 flex items-center justify-end gap-2">
          ${isRenew?'<span class="text-xs text-slate-400">Ù¾ÛŒØ´â€ŒÙØ±Ø¶: ÛŒÚ© Ù‡ÙØªÙ‡ Ù¾Ø³ Ø§Ø² Ø³Ø±Ø±Ø³ÛŒØ¯ ÙØ¹Ù„ÛŒ</span>':''}
          <button id="ed_save" class="px-4 py-2 rounded bg-slate-600">Ø«Ø¨Øª</button>
        </div>
      </div>`;
    document.body.appendChild(w);
    // defaults
    const borrowed = new Date(l.borrowed_at);
    const due = opts.dueDefault || new Date(l.due_at);
    document.getElementById('ed_borrowed').value = JalaliUtil.toJalaliString(borrowed);
    document.getElementById('ed_due').value = JalaliUtil.toJalaliString(due);
    document.getElementById('ed_member').value='';

    attachJalaliPicker(document.getElementById('ed_borrowed'));
    attachJalaliPicker(document.getElementById('ed_due'));

    document.getElementById('ed_save').onclick = async ()=>{
      const pb = JalaliUtil.fromJalaliString(document.getElementById('ed_borrowed').value);
      const pd = JalaliUtil.fromJalaliString(document.getElementById('ed_due').value);
      if(!pb || !pd) return toast('ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
      let member_id = l.member_id;
      const q = document.getElementById('ed_member').value.trim();
      if(q){ member_id = await findMemberIdByQuery(q) || member_id; }
      const patch = { borrowed_at: pb.toISOString(), due_at: pd.toISOString(), member_id };
      if(isRenew) patch.renewals_count = (l.renewals_count||0)+1;
      const { error } = await supa.from('loans').update(patch).eq('id', l.id);
      if(error) return toast(error.message);
      toast(isRenew?'ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯':'Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯');
      w.remove(); loadLoans();
    };
  }

  async function loadLoans(){
    const { data: loans, error } = await supa.from('loans').select('*, books(title), members(first_name,last_name)').is('returned_at', null).order('borrowed_at', {ascending:false});
    if(error) return toast(error.message);
    const now = new Date();
    const overdue = (loans||[]).filter(l => l.due_at && new Date(l.due_at) < now);
    const normal = (loans||[]).filter(l => !overdue.includes(l));

    const card = (l)=>{
      const member = (l.members? ((l.members.first_name||'')+' '+(l.members.last_name||'')) : ('Ø¹Ø¶Ùˆ #'+l.member_id));
      const title = l.books? l.books.title : ('Ú©ØªØ§Ø¨ #'+l.book_id);
      const jb = JalaliUtil.toJalaliString(new Date(l.borrowed_at));
      const jd = JalaliUtil.toJalaliString(new Date(l.due_at));
      return `
      <div class="glass rounded-2xl p-4 flex items-center justify-between">
        <div class="text-sm">
          <div class="font-bold">${title}</div>
          <div class="text-slate-300">${member}</div>
          <div class="text-xs text-slate-400">Ø§Ù…Ø§Ù†Øª: ${jb} â€¢ Ø³Ø±Ø±Ø³ÛŒØ¯: ${jd} â€¢ ØªÙ…Ø¯ÛŒØ¯: ${l.renewals_count||0} Ø¨Ø§Ø±</div>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <button class="px-3 py-1 rounded bg-amber-600" onclick="returnLoan(${l.id})">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
          <button class="px-3 py-1 rounded bg-slate-600" onclick="editLoan(${l.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
          <button class="px-3 py-1 rounded bg-emerald-700" onclick="renewLoan(${l.id})">ØªÙ…Ø¯ÛŒØ¯</button>
        </div>
      </div>`;
    };

    const overBox = document.getElementById('loanListOverdue');
    const overWrap = document.getElementById('overdueBox');
    if(overdue.length){ overWrap.classList.remove('hidden'); overBox.innerHTML = overdue.map(card).join(''); }
    else { overWrap.classList.add('hidden'); overBox.innerHTML=''; }

    document.getElementById('loanList').innerHTML = normal.map(card).join('');
  }

  window.loadLoans = loadLoans;
})();
</script>

</body>
</html>
