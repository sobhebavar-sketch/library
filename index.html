<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú©Ø§Ù†ÙˆÙ† Ù…Ù‡Ø¯ÙˆÛŒØª ØµØ¨Ø­ Ø¨Ø§ÙˆØ±</title>
  <meta name="description" content="Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø¯Ù‡ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ â€” Ù†Ù…Ø§ÛŒØ´ Ø¹Ù…ÙˆÙ…ÛŒ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆØ³Ø· Ú©ØªØ§Ø¨Ø¯Ø§Ø±" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    html, body { height: 100%; background: #0b1020; }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.08); }
    .chip { border:1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.05); }
    input, select, textarea { background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); }
    label { font-size: 12px; color: rgba(226,232,240,.8); }
  </style>

</head>
<body class="text-slate-100">
  <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <img id="logo" alt="Ù„ÙˆÚ¯Ùˆ" class="max-w-16 max-h-16 rounded-2xl border border-white/20 object-contain hidden" />
        <span id="logoFallback" class="inline-flex items-center justify-center w-10 h-10 rounded-2xl bg-indigo-500/20 border border-indigo-400/30">
          <i data-lucide="book" class="w-6 h-6 text-indigo-300"></i>
        </span>
        <div>
          <h1 class="text-2xl font-bold">Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú©Ø§Ù†ÙˆÙ† Ù…Ù‡Ø¯ÙˆÛŒØª ØµØ¨Ø­ Ø¨Ø§ÙˆØ±</h1>
          <p id="tagline" class="text-xs text-slate-300/70">Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒØ› Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆØ³Ø· Ú©ØªØ§Ø¨Ø¯Ø§Ø±</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="btnAdminAuth" class="px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">ÙˆØ±ÙˆØ¯ Ú©ØªØ§Ø¨Ø¯Ø§Ø±</button>
        <div id="userBox" class="hidden items-center gap-3"></div>
      </div>
    </header>

    <section id="catalog" class="glass rounded-3xl p-5 mb-6">
      <div class="flex flex-col sm:flex-row gap-3 items-center justify-between mb-4">
        <div class="flex gap-2 w-full sm:w-auto">
          <input id="search" class="rounded-xl px-3 py-2 w-full sm:w-96" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†ØŒ Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡ØŒ Ù…ØªØ±Ø¬Ù…ØŒ Ù…ÙˆØ¶ÙˆØ¹ØŒ Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡ØŒ Ù†Ø§Ø´Ø±ØŒ Ø³Ø§Ù„ØŒ ISBN" />
          <button id="btnSearch" class="px-4 py-2 rounded-xl bg-indigo-500">Ø¬Ø³ØªØ¬Ùˆ</button>
        </div>
        <div class="text-sm text-slate-300/80">ØªØ¹Ø¯Ø§Ø¯: <span class="px-2 py-1 rounded-lg chip" id="catalogCount">â€”</span></div>
      </div>
      <div id="catalogList" class="grid lg:grid-cols-2 gap-3"></div>
    </section>

    <section id="adminShell" class="hidden">
      <div class="flex flex-wrap gap-2 mb-4">
        <button data-tab="admin-books" class="tab chip px-4 py-2 rounded-xl">ğŸ“š Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</button>
        <button data-tab="admin-members" class="tab chip px-4 py-2 rounded-xl">ğŸ‘¥ Ø§Ø¹Ø¶Ø§</button>
        <button data-tab="admin-loans" class="tab chip px-4 py-2 rounded-xl">ğŸ”„ Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§</button>
        <button data-tab="admin-import" class="tab chip px-4 py-2 rounded-xl">â¬†ï¸ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª/â¬‡ï¸ Ø§Ú©Ø³Ù¾ÙˆØ±Øª</button>
        <button data-tab="admin-settings" class="tab chip px-4 py-2 rounded-xl">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
      </div>

      <div id="tab-admin-books" class="glass rounded-3xl p-5 hidden">
        <h3 class="font-bold mb-4">Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ú©ØªØ§Ø¨</h3>
        <form id="bookForm" class="grid md:grid-cols-3 gap-4 mb-6">
          <div class="md:col-span-2 grid grid-cols-2 gap-4">
            <div class="col-span-2">
              <label>Ø¹Ù†ÙˆØ§Ù† *</label>
              <input id="bk_title" class="rounded-xl px-3 py-2 w-full" required />
            </div>
            <div><label>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</label><input id="bk_author" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ù…ØªØ±Ø¬Ù…</label><input id="bk_translator" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ø³Ø§Ù„ Ø§Ù†ØªØ´Ø§Ø±</label><input id="bk_published_year" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª</label><input id="bk_pages" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ù…ÙˆØ¶ÙˆØ¹</label><input id="bk_subject" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ ; Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)</label><input id="bk_keywords" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ø§Ù†ØªØ´Ø§Ø±Ø§Øª</label><input id="bk_publisher" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>Ú©Ø¯/ISBN</label><input id="bk_isbn" class="rounded-xl px-3 py-2 w-full" /></div>
            <div><label>ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡ *</label><input id="bk_total" type="number" min="1" value="1" class="rounded-xl px-3 py-2 w-full" required /></div>
          </div>
          <div>
            <label>Ø¹Ú©Ø³ Ø¬Ù„Ø¯</label>
            <input id="bk_cover" type="file" accept="image/*" class="block w-full text-sm" />
            <input id="bk_cover_url" type="url" placeholder="ÛŒØ§ Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³ Ø¬Ù„Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="mt-2 rounded-xl px-3 py-2 w-full" />
            <img id="coverPreview" class="mt-3 rounded-xl max-h-48 hidden" />
          </div>
          <div class="md:col-span-3">
            <button class="px-4 py-2 rounded-xl bg-emerald-600">Ø°Ø®ÛŒØ±Ù‡</button>
          </div>
        </form>
        <h3 class="font-bold mb-2">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</h3>
        <div id="adminBooks" class="space-y-3"></div>
      </div>

      <div id="tab-admin-members" class="glass rounded-3xl p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold">Ø§Ø¹Ø¶Ø§</h3>
          <button id="btnAddMember" class="px-3 py-2 rounded-xl bg-slate-600">Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ</button>
        </div>
        <div id="membersList" class="space-y-3"></div>
      </div>

      
      <div id="tab-admin-loans" class="glass rounded-3xl p-5 hidden">
        <h3 class="font-bold mb-4">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</h3>
        <form id="loanForm" class="grid md:grid-cols-4 gap-4 mb-6">
          <div class="md:col-span-2">
            <label>Ø¹Ø¶Ùˆ</label>
            <input id="loan_member_query" class="rounded-xl px-3 py-2 w-full" placeholder="Ù†Ø§Ù…/Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ/Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ" autocomplete="off" />
            <div id="loan_member_results" class="mt-2 text-sm"></div>
          </div>
          <div class="md:col-span-2">
            <label>Ú©ØªØ§Ø¨</label>
            <input id="loan_book_query" class="rounded-xl px-3 py-2 w-full" placeholder="Ø¹Ù†ÙˆØ§Ù†/Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡/ISBN" autocomplete="off" />
            <div id="loan_book_results" class="mt-2 text-sm"></div>
          </div>

          <div>
            <label>ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª (Ù‡Ø¬Ø±ÛŒ Ø´Ù…Ø³ÛŒ)</label>
            <div class="date-input-wrap">
              <input id="loan_borrowed" type="text" data-jalali class="rounded-xl px-3 py-2 w-full" readonly />
              <button type="button" id="btn_open_borrowed" class="date-btn" style="width:32px;height:32px;display:inline-flex" aria-label="Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØªÙ‚ÙˆÛŒÙ…"><i data-lucide="calendar" class="w-4 h-4"></i></button>
            </div>
          </div>
          <div>
            <label>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ù‡Ø¬Ø±ÛŒ Ø´Ù…Ø³ÛŒ)</label>
            <div class="date-input-wrap">
              <input id="loan_due" type="text" data-jalali class="rounded-xl px-3 py-2 w-full" readonly />
              <button type="button" id="btn_open_due" class="date-btn" style="width:32px;height:32px;display:inline-flex" aria-label="Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØªÙ‚ÙˆÛŒÙ…"><i data-lucide="calendar" class="w-4 h-4"></i></button>
            </div>
          </div>

          <div class="md:col-span-4"><button class="px-4 py-2 rounded-xl bg-emerald-600">Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª</button></div>
        </form>

        <h3 class="font-bold mb-3">Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚ (Ú¯Ø°Ø´ØªÙ‡ Ø§Ø² Ø³Ø±Ø±Ø³ÛŒØ¯)</h3>
        <div id="loanListOverdue" class="space-y-3 mb-6"></div>

        <h3 class="font-bold mb-2">Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h3>
        <div id="loanList" class="space-y-3"></div>
      </div>
      <div id="tab-admin-import"
     class="glass rounded-3xl p-5 hidden">
        <h3 class="font-bold mb-4">Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ú©Ø³Ù„/CSV</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-bold mb-2">Ø§Ø¹Ø¶Ø§</h4>
            <input id="fileMembers" type="file" accept=".xlsx,.xls,.csv" />
            <p class="text-xs text-slate-300 mt-2">Ø³ØªÙˆÙ†â€ŒÙ‡Ø§: first_name, last_name, entry_year, degree, student_id, phone, email</p>
            <button id="btnImportMembers" class="mt-3 px-3 py-2 rounded-xl bg-indigo-500">Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ø¹Ø¶Ø§</button>
          </div>
          <div>
            <h4 class="font-bold mb-2">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</h4>
            <input id="fileBooks" type="file" accept=".xlsx,.xls,.csv" />
            <p class="text-xs text-slate-300 mt-2">Ø³ØªÙˆÙ†â€ŒÙ‡Ø§: title*, author, translator, pages, published_year, subject, keywords(Ø¨Ø§ ;), publisher, isbn, total_copies*, cover_url</p>
            <button id="btnImportBooks" class="mt-3 px-3 py-2 rounded-xl bg-indigo-500">Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</button>
          </div>
        </div>
        <hr class="my-6 border-white/10" />
        <h3 class="font-bold mb-2">Ø§Ú©Ø³Ù¾ÙˆØ±Øª CSV</h3>
        <div class="flex flex-wrap gap-2">
          <button id="btnExportBooks" class="px-3 py-2 rounded-xl bg-slate-700">Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</button>
          <button id="btnExportMembers" class="px-3 py-2 rounded-xl bg-slate-700">Ø§Ø¹Ø¶Ø§</button>
          <button id="btnExportLoans" class="px-3 py-2 rounded-xl bg-slate-700">Ø§Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§</button>
        </div>
      </div>

      <div id="tab-admin-settings" class="glass rounded-3xl p-5 hidden">
        <h3 class="font-bold mb-4">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
        <form id="settingsForm" class="grid md:grid-cols-3 gap-4">
          <div><label>Ù…Ø¯Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù…Ø§Ù†Øª (Ø±ÙˆØ²)</label><input id="st_default_days" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
          <div><label>Ù…Ø¯Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØªÙ…Ø¯ÛŒØ¯ (Ø±ÙˆØ²)</label><input id="st_renew_days" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
          <div class="md:col-span-3"><label>Ù„ÙˆÚ¯ÙˆÛŒ Ø³Ø§ÛŒØª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="st_logo" type="file" accept="image/*" /></div>
          <div class="md:col-span-3"><label>Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ø§ÛŒ Ø³Ø§ÛŒØª</label><input id="st_tagline" class="rounded-xl px-3 py-2 w-full" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø³Ø§Ù…Ø§Ù†Ù‡ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ú©Ø§Ù†ÙˆÙ†..." /></div>
          <div class="md:col-span-3"><button class="px-4 py-2 rounded-xl bg-emerald-600">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button></div>
        </form>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-400/80">
      Ú©Ø§Ù†ÙˆÙ† Ù…Ù‡Ø¯ÙˆÛŒØª ØµØ¨Ø­ Ø¨Ø§ÙˆØ± â€¢ Ù…Ø¹Ø§ÙˆÙ†Øª ÙØ±Ù‡Ù†Ú¯ÛŒ Ùˆ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ ØµÙ†Ø¹ØªÛŒ Ø§ØµÙÙ‡Ø§Ù†
    </footer>
  </div>

<script>
const SUPABASE_URL = "https://haqocojpgoqiktftdjyw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhcW9jb2pwZ29xaWt0ZnRkanl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MjA4MzIsImV4cCI6MjA3NzI5NjgzMn0.X7PMt1j3wpIBHNfn6RVz_SzDCnqTRZgHtLx0XidsF7Y";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (sel)=> document.querySelector(sel);
const $$ = (sel)=> Array.from(document.querySelectorAll(sel));
const fmtDate = (s)=>{
  try{
    if(!s) return 'â€”';
    const d = new Date(s);
    const y = d.getUTCFullYear();
    if(!(y>=1900 && y<=2100)) return new Date(s).toLocaleDateString('fa-IR');
    const j = g2j(y, d.getUTCMonth()+1, d.getUTCDate());
    return fmtJ(j[0], j[1], j[2]);
  }catch(e){
    try{ return new Date(s).toLocaleDateString('fa-IR'); }catch(_){ return s||'â€”'; }
  }
};
function is404(err){ try{ return (err && (err.code==="PGRST116" || (err.message||'').includes('rpc') || (err.status||'')===404)); }catch(_){ return false; } }
function isBadYear(y){ return !(y>=1900 && y<=2100); }
const toast = (msg)=>{ const el=document.createElement('div'); el.className='fixed bottom-4 right-4 bg-black/80 text-white px-3 py-2 rounded-xl text-sm'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3000); };

function toCSV(rows){
  if(!rows || !rows.length) return '';
  const headers = Object.keys(rows[0]);
  const csvRows = [headers.join(',')];
  for(const r of rows){
    const values = headers.map(h=> `"${(r[h]??'').toString().replace(/"/g,'""')}"`);
    csvRows.push(values.join(','));
  }
  return csvRows.join('\n');
}
const download = (filename, content, mime='text/csv')=>{
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
};

let user = null, profile = null;
async function refreshSession(){
  const { data:{ session } } = await supabase.auth.getSession();
  user = session?.user || null;
  if(user){
    const { data: p } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
    profile = p || { id:user.id, full_name:user.email, is_admin:false };
  }
  renderHeader();
}
function renderHeader(){
  const userBox = $('#userBox');
  if(!user || !profile?.is_admin){
    userBox.classList.add('hidden');
    $('#adminShell').classList.add('hidden');
    return;
  }
  userBox.classList.remove('hidden');
  userBox.innerHTML = `
    <span class="chip px-2 py-1 rounded-lg text-xs">Ú©ØªØ§Ø¨Ø¯Ø§Ø±</span>
    <span class="text-sm">${profile?.full_name || user.email}</span>
    <button id="btnSignOut" class="px-3 py-1 rounded-xl bg-rose-600">Ø®Ø±ÙˆØ¬</button>
  `;
  $('#btnSignOut').onclick = async ()=>{ await supabase.auth.signOut(); location.reload(); };
  $('#adminShell').classList.remove('hidden');
  selectTab('admin-books');
  loadAdminBooks(); loadMembers(); loadLoans(); loadSettings();
}

$('#btnAdminAuth').onclick = async () => {
  const email = prompt('Ø§ÛŒÙ…ÛŒÙ„ Ú©ØªØ§Ø¨Ø¯Ø§Ø±:');
  const password = email ? prompt('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:') : null;
  if(!email || !password) return;

  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(!error){ await refreshSession(); return; }

  const needSignup = error.message?.includes('Invalid login credentials') || error.status === 400;
  if(needSignup){
    const { error: e2 } = await supabase.auth.signUp({ email, password });
    if(e2){ toast(e2.message); return; }
    toast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ø› Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø±ÙˆÛŒ Â«ÙˆØ±ÙˆØ¯ Ú©ØªØ§Ø¨Ø¯Ø§Ø±Â» Ø¨Ø²Ù†ÛŒØ¯.');
    return;
  }
  toast(error.message || 'Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯');
};

$$('.tab').forEach(btn=> btn.onclick = ()=> selectTab(btn.dataset.tab));
function selectTab(name){
  ["admin-books","admin-members","admin-loans","admin-import","admin-settings"].forEach(t=> $('#tab-'+t)?.classList.add('hidden'));
  $('#tab-'+name)?.classList.remove('hidden');
  $$('.tab').forEach(b=> b.classList.remove('bg-white/10'));
  document.querySelector(`[data-tab="${name}"]`)?.classList.add('bg-white/10');
  if(name==='admin-loans'){ setDefaultLoanDates(); }
}

$('#btnSearch').onclick = ()=> loadCatalog($('#search').value.trim());

async function loadCatalog(q=''){
  let query = supabase.from('books').select('id,title,author,translator,subject,keywords,publisher,isbn,published_year,pages,total_copies,available_copies,cover_url').order('title');
  if(q){
    query = query.or(`title.ilike.%${q}%,author.ilike.%${q}%,translator.ilike.%${q}%,subject.ilike.%${q}%,publisher.ilike.%${q}%,isbn.ilike.%${q}%`);
  }
  const { data, error } = await query;
  if(error) return toast(error.message);
  const list = document.querySelector('#catalogList');
  const count = document.querySelector('#catalogCount');
  if(count) count.textContent = (data||[]).length + ' Ú©ØªØ§Ø¨';
  list.innerHTML = (data||[]).map(b=>{
    const available = (b.available_copies ?? 0) > 0;
    const kw = Array.isArray(b.keywords) ? b.keywords.filter(Boolean) :
               (typeof b.keywords === 'string' ? b.keywords.split(';').map(s=>s.trim()).filter(Boolean) : []);
    const mid = `more-${b.id}`;
    return `
      <div class="glass rounded-2xl p-4">
        <div class="flex items-start gap-4">
          <img src="${b.cover_url||''}" alt="cover" class="w-20 h-28 object-cover rounded-xl border border-white/10 ${b.cover_url? '' : 'hidden'}"/>
          <div class="flex-1">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-bold">${b.title||'â€”'}</div>
                <div class="text-sm text-slate-300/80">Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: ${b.author||'â€”'} ${b.translator? `â€¢ Ù…ØªØ±Ø¬Ù…: ${b.translator}`:''}</div>
                <div class="text-xs text-slate-400 mt-1">${b.publisher? `Ø§Ù†ØªØ´Ø§Ø±Ø§Øª: ${b.publisher}`:''}</div>
                <button class="mt-2 text-xs px-2 py-1 rounded-lg bg-white/10 hover:bg-white/20"
                        onclick="const el=document.getElementById('${mid}'); el.classList.toggle('hidden'); this.textContent = el.classList.contains('hidden') ? 'Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±' : 'Ù†Ù…Ø§ÛŒØ´ Ú©Ù…ØªØ±';">
                  Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±
                </button>
                <div id="${mid}" class="hidden text-xs text-slate-400 mt-2 leading-6">
                  ${b.subject? `Ù…ÙˆØ¶ÙˆØ¹: ${b.subject}<br/>`:''}
                  ${b.published_year? `Ø³Ø§Ù„ Ø§Ù†ØªØ´Ø§Ø±: ${b.published_year}<br/>`:''}
                  ${b.pages? `ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª: ${b.pages}<br/>`:''}
                  ${b.isbn? `ISBN: ${b.isbn}<br/>`:''}
                  ${kw.length? `<div class="mt-1 flex flex-wrap gap-1">${kw.map(k=>`<span class='chip px-2 py-0.5 rounded-lg'>${k}</span>`).join('')}</div>`:''}
                </div>
              </div>
              <div class="text-sm flex flex-col items-end gap-2">
                <span class="chip px-2 py-1 rounded-lg ${available? 'text-emerald-300' : 'text-rose-300'}">${available? 'Ù…ÙˆØ¬ÙˆØ¯' : 'Ø§Ù…Ø§Ù†Øª'}</span>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }).join('');
}

const coverInput = $('#bk_cover');
const coverUrlInput = $('#bk_cover_url');
coverInput?.addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if(f){ const url = URL.createObjectURL(f); $('#coverPreview').src=url; $('#coverPreview').classList.remove('hidden'); }
});
coverUrlInput?.addEventListener('input', (e)=>{
  const link = (e.target.value||'').trim();
  if(link){ $('#coverPreview').src = link; $('#coverPreview').classList.remove('hidden'); }
});

$('#bookForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const title = $('#bk_title').value.trim();
  if(!title) return toast('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
  const { data: exists } = await supabase.from('books').select('id').ilike('title', title).limit(1);
  if((exists||[]).length){ toast('Ú©ØªØ§Ø¨ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø¹Ù†ÙˆØ§Ù† Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª'); return; }

  let cover_url = null;
  const link = (coverUrlInput?.value||'').trim();
  const file = coverInput?.files?.[0];
  if(link){
    cover_url = link;
  } else if(file){
    const safeName = ('c'+Date.now()+'-'+file.name).replace(/[^a-zA-Z0-9\.\-_]/g,'_');
    const up = await supabase.storage.from('book_covers').upload(safeName, file, { contentType: file.type, upsert: true });
    if(up.error) return toast(up.error.message);
    const pub = supabase.storage.from('book_covers').getPublicUrl(up.data.path); cover_url = pub.data.publicUrl;
  }

  const payload = {
    title,
    author: $('#bk_author').value.trim(),
    translator: $('#bk_translator').value.trim()||null,
    pages: parseInt($('#bk_pages').value,10)||null,
    published_year: parseInt($('#bk_published_year').value,10)||null,
    subject: $('#bk_subject').value.trim()||null,
    keywords: ($('#bk_keywords').value||'').split(';').map(s=>s.trim()).filter(Boolean),
    publisher: $('#bk_publisher').value.trim()||null,
    isbn: $('#bk_isbn').value.trim()||null,
    total_copies: parseInt($('#bk_total').value,10)||1,
    available_copies: parseInt($('#bk_total').value,10)||1,
    cover_url
  };
  const { error } = await supabase.from('books').insert(payload);
  if(error) return toast(error.message);
  toast('Ú©ØªØ§Ø¨ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
  ['#bk_title','#bk_author','#bk_translator','#bk_pages','#bk_published_year','#bk_subject','#bk_keywords','#bk_publisher','#bk_isbn'].forEach(s=> $(s).value='');
  $('#bk_total').value = 1; $('#bk_cover').value=''; $('#bk_cover_url').value=''; $('#coverPreview').classList.add('hidden');
  loadCatalog(); loadAdminBooks();
});
async function loadAdminBooks(){
  const { data, error } = await supabase.from('books').select('*').order('created_at', { ascending:false });
  if(error) return toast(error.message);
  $('#adminBooks').innerHTML = (data||[]).map(b=>`
    <div class="glass rounded-2xl p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="${b.cover_url||''}" class="w-12 h-16 object-cover rounded-lg border border-white/10 ${b.cover_url? '': 'hidden'}"/>
        <div>
          <div class="font-bold">${b.title}</div>
          <div class="text-xs text-slate-400">Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: ${b.author||'â€”'} ${b.translator? 'â€¢ Ù…ØªØ±Ø¬Ù…: '+b.translator:''} â€¢ Ø§Ù†ØªØ´Ø§Ø±Ø§Øª: ${b.publisher||'â€”'} â€¢ Ø³Ø§Ù„: ${b.published_year||'â€”'}</div>
        </div>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <span class="chip px-2 py-1 rounded-lg">Ù…ÙˆØ¬ÙˆØ¯: ${b.available_copies}/${b.total_copies}</span>
        <button class="px-3 py-1 rounded-lg bg-slate-600" onclick='editBook(${JSON.stringify(b).replaceAll("'","&#39;")})'>ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="px-3 py-1 rounded-lg bg-rose-600" onclick="deleteBook(${b.id})">Ø­Ø°Ù</button>
      </div>
    </div>`).join('');
}
async function deleteBook(id){
  if(!confirm('Ú©ØªØ§Ø¨ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  const { error } = await supabase.from('books').delete().eq('id', id);
  if(error) return toast(error.message);
  toast('Ø­Ø°Ù Ø´Ø¯'); loadCatalog(); loadAdminBooks();
}
async function editBook(b){ /* replaced by modal version */ return window.editBook(b); }

async function loadMembers(){
  const { data, error } = await supabase.from('members').select('*').order('last_name');
  if(error) return toast(error.message);
  $('#membersList').innerHTML = (data||[]).map(m=>`
    <div class="glass rounded-2xl p-4 flex items-center justify-between">
      <div>
        <div class="font-bold">${m.first_name||''} ${m.last_name||''}</div>
        <div class="text-xs text-slate-400">${m.degree||''} â€¢ ${m.entry_year||''} â€¢ ${m.student_id||''} â€¢ ${m.email||''} â€¢ ${m.phone||''}</div>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <button class="px-3 py-1 rounded-lg bg-slate-600" onclick='editMember(${JSON.stringify(m).replaceAll("'","&#39;")})'>ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="px-3 py-1 rounded-lg bg-rose-600" onclick="deleteMember(${m.id})">Ø­Ø°Ù</button>
      </div>
    </div>`).join('');
}
async function editMember(m){ /* replaced by modal version */ return window.editMember(m); }
async function deleteMember(id){
  if(!confirm('Ø¹Ø¶Ùˆ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  const { error } = await supabase.from('members').delete().eq('id', id);
  if(error) return toast(error.message); toast('Ø­Ø°Ù Ø´Ø¯'); loadMembers();
}

$('#loanForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const memberId = $('#loan_member_results')?.dataset.sel;
  const bookId = $('#loan_book_results')?.dataset.sel;
  if(!memberId || !bookId) { toast('Ø¹Ø¶Ùˆ Ùˆ Ú©ØªØ§Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }

  // Borrowed date (Jalali) -> Gregorian ISO
  let borrowed_at_iso;
  let bStr = normalizeJalali($('#loan_borrowed').value?.trim());
  if (bStr) {
    try {
      const parts = bStr.split('/').map(x=>parseInt(x,10));
      const pb = j2g(parts[0], parts[1], parts[2]);
      const gb = new Date(Date.UTC(pb[0], pb[1]-1, pb[2], 12, 0, 0));
      borrowed_at_iso = gb.toISOString();
    } catch(e){}
  }
  if(!borrowed_at_iso){ borrowed_at_iso = new Date().toISOString(); }

  // Due date (Jalali) -> Gregorian ISO
  let due_at_iso;
  let dueStr = normalizeJalali($('#loan_due').value?.trim());
  if (dueStr) {
    try {
      const parts = dueStr.split('/').map(x=>parseInt(x,10));
      let pd = j2g(parts[0], parts[1], parts[2]);
      if(isBadYear(pd[0])){
        // Fallback: add settings days to today in UTC
        let base = new Date();
        let g = new Date(Date.UTC(base.getUTCFullYear(), base.getUTCMonth(), base.getUTCDate()+ (window.__loan_days__||14), 12,0,0));
        due_at_iso = g.toISOString();
      } else {
        const g = new Date(Date.UTC(pd[0], pd[1]-1, pd[2], 12, 0, 0));
        due_at_iso = g.toISOString();
      }
    } catch(e){}
  }
  if(!due_at_iso){
    let days = 14;
try{
  const { data: st } = await supabase.from('settings').select('default_loan_days').eq('id',1).maybeSingle();
  if(st && typeof st.default_loan_days === 'number') days = st.default_loan_days; window.__loan_days__ = days;
}catch(_){}
due_at_iso = new Date(Date.now() + days*24*3600*1000).toISOString();
  }

  // Try RPC with borrowed_at support first; fallback if arg not accepted
  let rpcError = null, loan = null;
  let payload = {
  p_book_id: parseInt(bookId, 10),
  p_member_id: parseInt(memberId, 10),
  p_admin_id: user.id,
  p_due_at: due_at_iso
};
  let res; try{ res = await supabase.rpc('issue_loan', payload); }catch(e){ res = { error: e }; }
  if(res.error){
  // Fallback to direct insert when RPC is missing or incompatible
  if(is404(res.error)){
    let ins = await supabase.from('loans').insert({
      book_id: parseInt(bookId,10),
      member_id: parseInt(memberId,10),
      admin_id: user.id,
      borrowed_at: borrowed_at_iso,
      due_at: due_at_iso
    }).select().maybeSingle();
    if(ins.error){ toast(ins.error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª'); return; }
    loan = ins.data;
  } else {
    // Retry without p_borrowed_at via RPC
    payload = { p_book_id: parseInt(bookId,10), p_member_id: parseInt(memberId,10), p_admin_id: user.id, p_due_at: due_at_iso };
    res = await supabase.rpc('issue_loan', payload);
    if(res.error){ toast(res.error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª'); return; }
    loan = res.data;
    }
} else {
  loan = res.data;
}

  toast('Ø§Ù…Ø§Ù†Øª Ø«Ø¨Øª Ø´Ø¯');
  // Reset quick inputs
  $('#loan_member_results').innerHTML=''; $('#loan_member_results').dataset.sel='';
  $('#loan_book_results').innerHTML=''; $('#loan_book_results').dataset.sel='';
  loadCatalog(); loadLoans();
});



$('#loan_member_query')?.addEventListener('input', async (e)=>{
  const q = e.target.value.trim();
  const box = $('#loan_member_results');
  if(!q){ box.innerHTML=''; box.dataset.sel=''; return; }
  let { data, error } = await supabase.from('members')
    .select('id,first_name,last_name,student_id')
    .or(`first_name.ilike.%${q}%,last_name.ilike.%${q}%,student_id.ilike.%${q}%`)
    .limit(8);
  if(error){ box.innerHTML=''; return; }
  box.innerHTML = (data||[]).map(m =>
    `<button class="chip px-2 py-1 rounded" data-id="${m.id}">${m.first_name||''} ${m.last_name||''} â€¢ ${m.student_id||''}</button>`
  ).join('');
  $$('#loan_member_results button').forEach(b => b.onclick = () => { box.dataset.sel = b.dataset.id; toast('Ø¹Ø¶Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯'); });
});


$('#loan_book_query')?.addEventListener('input', async (e)=>{
  const q = e.target.value.trim();
  const box = $('#loan_book_results');
  if(!q){ box.innerHTML=''; box.dataset.sel=''; return; }
  let { data, error } = await supabase.from('books')
    .select('id,title,author,isbn,available_copies')
    .or(`title.ilike.%${q}%,author.ilike.%${q}%,isbn.ilike.%${q}%`)
    .gte('available_copies',1)
    .limit(8);
  if(error){ box.innerHTML=''; return; }
  box.innerHTML = (data||[]).map(b =>
    `<button class="chip px-2 py-1 rounded" data-id="${b.id}">${b.title||''}${b.author ? ' â€¢ '+b.author : ''}${b.isbn ? ' â€¢ '+b.isbn : ''}</button>`
  ).join('');
  $$('#loan_book_results button').forEach(b => b.onclick = () => { box.dataset.sel = b.dataset.id; toast('Ú©ØªØ§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯'); });
});

async function loadLoans(){
  const { data, error } = await supabase
    .from('loans')
    .select('id,borrowed_at,due_at,returned_at, renewals_count, members:member_id(first_name,last_name), books:book_id(title), admins:issued_by_admin_id(full_name)')
    .is('returned_at', null)
    .order('borrowed_at',{ascending:false});
  if(error) return toast(error.message);

  const now = new Date();
  const overdue = (data||[]).filter(l => l.due_at && new Date(l.due_at) < now);
  const active = (data||[]).filter(l => !l.due_at || new Date(l.due_at) >= now);

  // Overdue list
  $('#loanListOverdue').innerHTML = overdue.map(l=>`
    <div class="glass rounded-2xl p-4 border border-amber-400/30 bg-amber-500/5 space-y-2">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-bold text-amber-300">âš ï¸ ${l.books?.title||'â€”'}</div>
          <div class="text-xs text-slate-300">Ù…Ø³Ø¦ÙˆÙ„: ${l.admins?.full_name||'â€”'} â€¢ Ø§Ù…Ø§Ù†Øªâ€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡: ${(l.members?.first_name||'')+' '+(l.members?.last_name||'')}</div>
          <div class="text-xs text-slate-400">ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª: ${fmtDate(l.borrowed_at)} â€¢ Ø³Ø±Ø±Ø³ÛŒØ¯: ${fmtDate(l.due_at)} â€¢ ØªÙ…Ø¯ÛŒØ¯Ù‡Ø§: ${l.renewals_count ?? 0}</div>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-1 rounded-lg bg-slate-600" onclick="editLoan(${l.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
          <button class="px-3 py-1 rounded-lg bg-indigo-600" onclick="extendLoan(${l.id})">ØªÙ…Ø¯ÛŒØ¯</button>
          <button class="px-3 py-1 rounded-lg bg-amber-600" onclick="returnLoan(${l.id})">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
      </div>
    </div>`).join('');

  // Active list
  $('#loanList').innerHTML = active.map(l=>`
    <div class="glass rounded-2xl p-4 space-y-2">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-bold">${l.books?.title||'â€”'}</div>
          <div class="text-xs text-slate-300">Ù…Ø³Ø¦ÙˆÙ„: ${l.admins?.full_name||'â€”'} â€¢ Ø§Ù…Ø§Ù†Øªâ€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡: ${(l.members?.first_name||'')+' '+(l.members?.last_name||'')}</div>
          <div class="text-xs text-slate-400">ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª: ${fmtDate(l.borrowed_at)} â€¢ Ø³Ø±Ø±Ø³ÛŒØ¯: ${fmtDate(l.due_at)} â€¢ ØªÙ…Ø¯ÛŒØ¯Ù‡Ø§: ${l.renewals_count ?? 0}</div>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-1 rounded-lg bg-slate-600" onclick="editLoan(${l.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
          <button class="px-3 py-1 rounded-lg bg-indigo-600" onclick="extendLoan(${l.id})">ØªÙ…Ø¯ÛŒØ¯</button>
          <button class="px-3 py-1 rounded-lg bg-amber-600" onclick="returnLoan(${l.id})">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
      </div>
    </div>`).join('');
}

async function extendLoan(id){
  // Load loan & defaults
  const { data: l, error } = await supabase.from('loans').select('*').eq('id', id).maybeSingle();
  if(error || !l){ toast('ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
  const { data: st } = await supabase.from('settings').select('default_renew_days, default_loan_days').eq('id',1).maybeSingle();
  const addDaysN = (Number.isFinite(parseInt(st?.default_renew_days)) ? parseInt(st.default_renew_days,10)
                   : (Number.isFinite(parseInt(st?.default_loan_days)) ? parseInt(st.default_loan_days,10) : 14));

  const base = l.due_at ? new Date(l.due_at) : new Date();
  const newDue = addDaysUTC(base, addDaysN);

  const modal = document.getElementById('extend-modal');
  const inp = document.getElementById('extend_due');
  const btnOk = document.getElementById('extend_ok');
  const btnCancel = document.getElementById('extend_cancel');

  // Prefill Jalaali text (UTC-safe)
  try{ inp.value = jalaliFromISO(newDue.toISOString()); }catch(_){ inp.value = ''; }

  // Show modal
  modal.classList.remove('hidden'); modal.classList.add('flex');

  const handlerOk = async ()=>{
    let s = normalizeJalali(inp.value||'');
    if(!s){ toast('ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø±'); return; }
    const [jy,jm,jd] = s.split('/');
    const payload = { 
      due_at: isoFromJalaliUTC(jy,jm,jd),
      renewals_count: (l.renewals_count||0) + 1 
    };
    const { error: e2 } = await supabase.from('loans').update(payload).eq('id', id);
    if(e2){ toast(e2.message); return; }
    toast('ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯');
    modal.classList.add('hidden'); modal.classList.remove('flex');
    btnOk.removeEventListener('click', handlerOk);
    btnCancel.removeEventListener('click', handlerCancel);
    loadLoans();
  };
  const handlerCancel = ()=>{
    modal.classList.add('hidden'); modal.classList.remove('flex');
    btnOk.removeEventListener('click', handlerOk);
    btnCancel.removeEventListener('click', handlerCancel);
  };

  btnOk.addEventListener('click', handlerOk);
  btnCancel.addEventListener('click', handlerCancel);
}
async function returnLoan(id){
  const { data, error } = await supabase.rpc('return_loan', { p_loan_id: id });
  if (error) { toast(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¨Ø§Ø²Ú¯Ø´Øª'); return; }
  toast('Ø¨Ø§Ø²Ú¯Ø´Øª Ø«Ø¨Øª Ø´Ø¯'); loadCatalog(); loadLoans();
}

async function readSheet(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e=>{ const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws, {defval:''}); resolve(rows); };
    reader.onerror = reject; reader.readAsArrayBuffer(file);
  });
}
$('#btnImportMembers')?.addEventListener('click', async ()=>{
  const f = $('#fileMembers').files?.[0]; if(!f) return toast('ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
  const rows = await readSheet(f);
  const mapped = rows.map(r=>({
    first_name: r.first_name||r['first name']||r['Ù†Ø§Ù…']||null,
    last_name: r.last_name||r['last name']||r['Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ']||null,
    entry_year: parseInt(r.entry_year||r['entry year']||r['Ø³Ø§Ù„ ÙˆØ±ÙˆØ¯'])||null,
    degree: r.degree||r['Ù…Ù‚Ø·Ø¹']||null,
    student_id: (r.student_id||r['student id']||r['Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ']||'').toString()||null,
    phone: (r.phone||r['Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†']||'').toString()||null,
    email: r.email||r['Ø§ÛŒÙ…ÛŒÙ„']||null,
  }));
  const valid = mapped.filter(m=> m.first_name || m.last_name || m.student_id || m.email);
  if(!valid.length) return toast('Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
  const { error } = await supabase.from('members').insert(valid);
  if(error) return toast(error.message); toast('Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ø¹Ø¶Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); loadMembers();
});
$('#btnImportBooks')?.addEventListener('click', async ()=>{
  const f = $('#fileBooks').files?.[0]; if(!f) return toast('ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
  const rows = await readSheet(f);
  const mapped = rows.map(r=>({
    title: r.title||r['Ø¹Ù†ÙˆØ§Ù†']||'',
    author: r.author||r['Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡']||null,
    translator: r.translator||r['Ù…ØªØ±Ø¬Ù…']||null,
    pages: parseInt(r.pages||r['ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª'])||null,
    published_year: parseInt(r.published_year||r['Ø³Ø§Ù„ Ø§Ù†ØªØ´Ø§Ø±'])||null,
    subject: r.subject||r['Ù…ÙˆØ¶ÙˆØ¹']||null,
    keywords: ((r.keywords||r['Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§']||'')+'').split(';').map(s=>s.trim()).filter(Boolean),
    publisher: r.publisher||r['Ø§Ù†ØªØ´Ø§Ø±Ø§Øª']||null,
    isbn: r.isbn||r['ISBN']||null,
    total_copies: parseInt(r.total_copies||r['ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡'])||1,
    available_copies: parseInt(r.total_copies||r['ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡'])||1,
    cover_url: r.cover_url||null
  }));
  const valid = mapped.filter(b=> b.title);
  if(!valid.length) return toast('Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
  const { error } = await supabase.from('books').insert(valid);
  if(error) return toast(error.message); toast('Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); loadCatalog(); loadAdminBooks();
});
$('#btnExportBooks')?.addEventListener('click', async ()=>{ const { data } = await supabase.from('books').select('*'); download('books.csv', toCSV(data||[])); });
$('#btnExportMembers')?.addEventListener('click', async ()=>{ const { data } = await supabase.from('members').select('*'); download('members.csv', toCSV(data||[])); });
$('#btnExportLoans')?.addEventListener('click', async ()=>{ const { data } = await supabase.from('loans').select('id,book_id,member_id,borrowed_at,due_at,returned_at,renewals_count'); download('loans.csv', toCSV(data||[])); });

async function loadSettings(){
  const { data } = await supabase.from('settings').select('*').eq('id',1).maybeSingle();
  $('#st_default_days').value = data?.default_loan_days ?? 14;
  $('#st_renew_days').value = data?.default_renew_days ?? 7;
  $('#st_tagline').value = data?.tagline || '';
  if (data?.logo_url) { document.getElementById('logo').src = data.logo_url; document.getElementById('logo').classList.remove('hidden'); document.getElementById('logoFallback').classList.add('hidden'); }
  if (data?.tagline) { document.getElementById('tagline').textContent = data.tagline; }
}
$('#settingsForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  let logo_url = null;
  const file = document.getElementById('st_logo').files?.[0];
  if(file){
    const safe = ('logo-'+Date.now()+'-'+file.name).replace(/[^a-zA-Z0-9\.\-_]/g,'_');
    const up = await supabase.storage.from('book_covers').upload(safe, file, { contentType: file.type, upsert: true });
    if(up.error){ toast(up.error.message); return; }
    const pub = supabase.storage.from('book_covers').getPublicUrl(up.data.path); logo_url = pub.data.publicUrl;
  }
  const payload = {
    id: 1,
    default_loan_days: parseInt(document.getElementById('st_default_days').value,10)||14,
    default_renew_days: parseInt(document.getElementById('st_renew_days').value,10)||7,
    tagline: document.getElementById('st_tagline').value || null,
  };
  if(logo_url) payload.logo_url = logo_url;
  const { error } = await supabase.from('settings').upsert(payload, { onConflict: 'id' });
  if(error) return toast(error.message);
  toast('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
  loadSettings();
});

loadCatalog();
loadSettings();
refreshSession();

// === Helpers: Modals ===
function openModal(id){ const el=document.getElementById(id); if(!el) return; el.classList.remove('hidden'); el.classList.add('flex'); }
function closeModal(id){ const el=document.getElementById(id); if(!el) return; el.classList.add('hidden'); el.classList.remove('flex'); }

// === Datepicker init ===
// Init loan due picker on page
document.addEventListener('DOMContentLoaded', ()=>{
  
});

// === Book edit via modal ===
let CURRENT_BOOK = null;
async function editBook(b){ /* replaced by modal version */ return window.editBook(b); }

document.getElementById('formBookModal')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = parseInt(document.getElementById('mb_id').value, 10);
  const payload = {
    title: document.getElementById('mb_title').value.trim(),
    author: document.getElementById('mb_author').value.trim() || null,
    translator: document.getElementById('mb_translator').value.trim() || null,
    published_year: parseInt(document.getElementById('mb_published_year').value,10) || null,
    pages: parseInt(document.getElementById('mb_pages').value,10) || null,
    subject: document.getElementById('mb_subject').value.trim() || null,
    keywords: (document.getElementById('mb_keywords').value||'').split(';').map(s=>s.trim()).filter(Boolean),
    publisher: document.getElementById('mb_publisher').value.trim() || null,
    isbn: document.getElementById('mb_isbn').value.trim() || null,
    total_copies: parseInt(document.getElementById('mb_total_copies').value,10) || 1
  };
  // Cover change logic
  const file = document.getElementById('mb_cover_file')?.files?.[0];
  const link = (document.getElementById('mb_cover_url')?.value||'').trim();
  const clear = !!document.getElementById('mb_cover_clear')?.checked;
  try{
    if(clear){
      payload.cover_url = null;
    } else if(link){
      payload.cover_url = link;
    } else if(file){
      const safeName = ('c'+Date.now()+'-'+file.name).replace(/[^a-zA-Z0-9\.\-_]/g,'_');
      const up = await supabase.storage.from('book_covers').upload(safeName, file, { contentType: file.type, upsert: true });
      if(up.error){ toast(up.error.message); return; }
      const pub = supabase.storage.from('book_covers').getPublicUrl(up.data.path); payload.cover_url = pub.data.publicUrl;
    }
  }catch(err){ toast(err.message||'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ú©Ø³ Ø¬Ù„Ø¯'); return; }

  const { error } = await supabase.from('books').update(payload).eq('id', id);
  if(error){ toast(error.message); return; }
  toast('ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯');
  // mark as bound to avoid duplicate listener later
  document.getElementById('formBookModal').dataset.bound = '1';
  closeModal('modalBook'); loadCatalog(); loadAdminBooks();
});

// === Member add/edit via modal ===
function openAddMember(){
  document.getElementById('modalMemberTitle').textContent = 'Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ';
  document.getElementById('mm_id').value = '';
  ['mm_first_name','mm_last_name','mm_entry_year','mm_degree','mm_student_id','mm_phone','mm_email'].forEach(id=> document.getElementById(id).value='');
  openModal('modalMember');
}
async function editMember(m){ /* replaced by modal version */ return window.editMember(m); }

document.getElementById('formMemberModal')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('mm_id').value;
  const payload = {
    first_name: document.getElementById('mm_first_name').value.trim() || null,
    last_name: document.getElementById('mm_last_name').value.trim() || null,
    entry_year: parseInt(document.getElementById('mm_entry_year').value,10) || null,
    degree: document.getElementById('mm_degree').value.trim() || null,
    student_id: document.getElementById('mm_student_id').value.trim() || null,
    phone: document.getElementById('mm_phone').value.trim() || null,
    email: document.getElementById('mm_email').value.trim() || null,
  };
  if(id){
    const { error } = await supabase.from('members').update(payload).eq('id', parseInt(id,10));
    if(error){ toast(error.message); return; }
    toast('ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯');
  }else{
    const { error } = await supabase.from('members').insert(payload);
    if(error){ toast(error.message); return; }
    toast('Ø¹Ø¶Ùˆ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯');
  }
  closeModal('modalMember'); loadMembers();
});

// Replace "Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ" button handler
document.getElementById('btnAddMember')?.addEventListener('click', openAddMember);

// === Loan edit via modal & datepickers ===

async function editLoan(id){
  // Load loan
  const { data: l, error } = await supabase.from('loans')
    .select('id, member_id, borrowed_at, due_at, members:member_id(first_name,last_name)')
    .eq('id', id).maybeSingle();
  if(error || !l){ toast('ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }

  const modal = $('#edit-loan-modal');
  const q = $('#edit_member_query');
  const res = $('#edit_member_results');
  const inpBorrowed = $('#edit_borrowed');
  const inpDue = $('#edit_due');
  const btnSave = $('#edit_loan_save');
  const btnCancel = $('#edit_loan_cancel');

  // helper to set jalali to inputs
  const setJalali = (el, d)=>{
    const j = g2j(d.getUTCFullYear(), d.getUTCMonth()+1, d.getUTCDate());
    el.value = fmtJ(j[0], j[1], j[2]);
  };

  // Prefill fields
  try{
    const b = l.borrowed_at ? new Date(l.borrowed_at) : new Date();
    const d = l.due_at ? new Date(l.due_at) : new Date();
    setJalali(inpBorrowed, b);
    setJalali(inpDue, d);
  }catch(_){}

  // Show current member
  res.innerHTML = '';
  if(l.members){
    const nm = `${l.members.first_name||''} ${l.members.last_name||''}`.trim();
    const chip = document.createElement('button');
    chip.className = 'chip px-2 py-1 rounded-lg mr-1 mb-1 bg-indigo-700';
    chip.textContent = nm || 'â€”';
    chip.dataset.id = l.member_id;
    res.appendChild(chip);
    res.dataset.sel = String(l.member_id);
  } else { res.dataset.sel = ''; }
// Member search
  q.oninput = async (e)=>{
    const s = e.target.value.trim();
    if(!s){ res.innerHTML=''; res.dataset.sel=''; return; }
    let { data } = await supabase.from('members')
      .select('id,first_name,last_name,student_id')
      .or(`first_name.ilike.%${s}%,last_name.ilike.%${s}%,student_id.ilike.%${s}%`)
      .limit(10);
    res.innerHTML = (data||[]).map(m=>`<button class='chip px-2 py-1 rounded-lg mr-1 mb-1 bg-slate-600' data-id='${m.id}'>${m.first_name||''} ${m.last_name||''} (${m.student_id||''})</button>`).join('');
    $$('#edit_member_results button').forEach(b=> b.onclick = ()=>{ res.dataset.sel=b.dataset.id; toast('Ø¹Ø¶Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯'); });
  };

  // Show modal
  modal.classList.remove('hidden'); modal.classList.add('flex');

  const onCancel = ()=>{
    modal.classList.add('hidden'); modal.classList.remove('flex');
    btnSave.removeEventListener('click', onSave);
    btnCancel.removeEventListener('click', onCancel);
  };

  const onSave = async ()=>{
    // Parse Jalali inputs
    const bStr = normalizeJalali((inpBorrowed.value||'').replaceAll('-', '/'));
    const dStr = normalizeJalali((inpDue.value||'').replaceAll('-', '/'));
    if(!bStr || !dStr){ toast('ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø±'); return; }
    const bp = bStr.split('/').map(Number);
    const dp = dStr.split('/').map(Number);
    const bg = j2g(bp[0], bp[1], bp[2]);
    const dg = j2g(dp[0], dp[1], dp[2]);
    const payload = {
      borrowed_at: new Date(Date.UTC(bg[0], bg[1]-1, bg[2], 12, 0, 0)).toISOString(),
      due_at: new Date(Date.UTC(dg[0], dg[1]-1, dg[2], 12, 0, 0)).toISOString()
    };
    const sel = res.dataset.sel ? parseInt(res.dataset.sel,10) : null;
    if(sel && sel !== l.member_id) payload.member_id = sel;
    const { error: e2 } = await supabase.from('loans').update(payload).eq('id', id);
    if(e2){ toast(e2.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡'); return; }
    toast('Ø§Ù…Ø§Ù†Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯');
    onCancel();
    loadLoans();
  };

  btnSave.addEventListener('click', onSave);
  btnCancel.addEventListener('click', onCancel);
}


// --- Cover preview/update bindings for edit modal ---
(function(){
  const f = document.getElementById('mb_cover_file');
  const u = document.getElementById('mb_cover_url');
  const c = document.getElementById('mb_cover_clear');
  const p = document.getElementById('mb_cover_preview');
  if(f && !f.dataset.bound){
    f.addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(file){ p.src = URL.createObjectURL(file); p.classList.remove('hidden'); if(c) c.checked=false; }
    });
    f.dataset.bound = '1';
  }
  if(u && !u.dataset.bound){
    u.addEventListener('input', (e)=>{
      const link = (e.target.value||'').trim();
      if(link){ p.src = link; p.classList.remove('hidden'); if(c) c.checked=false; }
    });
    u.dataset.bound = '1';
  }
  if(c && !c.dataset.bound){
    c.addEventListener('change', (e)=>{
      if(e.target.checked){ p.classList.add('hidden'); p.removeAttribute('src'); if(u) u.value=''; if(f) f.value=''; }
    });
    c.dataset.bound = '1';
  }
})();

</script>

  <!-- === Modals === -->
  <!-- Book Modal -->
  <div id="modalBook" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="bg-slate-800 rounded-2xl p-5 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold" id="modalBookTitle">ÙˆÛŒØ±Ø§ÛŒØ´ Ú©ØªØ§Ø¨</h3>
        <button class="px-2 py-1 rounded-lg bg-slate-700" onclick="closeModal('modalBook')">âœ•</button>
      </div>
      <form id="formBookModal" class="grid md:grid-cols-3 gap-4">
        <input type="hidden" id="mb_id" />
        <div class="md:col-span-3"><label>Ø¹Ù†ÙˆØ§Ù† *</label><input id="mb_title" class="rounded-xl px-3 py-2 w-full" required /></div>
        <div><label>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡</label><input id="mb_author" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ù…ØªØ±Ø¬Ù…</label><input id="mb_translator" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ø³Ø§Ù„ Ø§Ù†ØªØ´Ø§Ø±</label><input id="mb_published_year" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª</label><input id="mb_pages" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-3"><label>Ù…ÙˆØ¶ÙˆØ¹</label><input id="mb_subject" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-3"><label>Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ (Ø¨Ø§ ; Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)</label><input id="mb_keywords" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2"><label>Ø§Ù†ØªØ´Ø§Ø±Ø§Øª</label><input id="mb_publisher" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ú©Ø¯/ISBN</label><input id="mb_isbn" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³Ø®Ù‡</label><input id="mb_total_copies" type="number" min="1" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-3">
          <label>Ø¹Ú©Ø³ Ø¬Ù„Ø¯</label>
          <div class="grid md:grid-cols-3 gap-3 items-start mt-1">
            <div class="md:col-span-2 space-y-2">
              <input id="mb_cover_file" type="file" accept="image/*" class="block w-full text-sm" />
              <input id="mb_cover_url" type="url" placeholder="ÛŒØ§ Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³ Ø¬Ù„Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" class="rounded-xl px-3 py-2 w-full" />
              <label class="inline-flex items-center gap-2 text-sm text-slate-300/80"><input id="mb_cover_clear" type="checkbox" /> Ø­Ø°Ù Ø¹Ú©Ø³ Ù…ÙˆØ¬ÙˆØ¯</label>
            </div>
            <div>
              <img id="mb_cover_preview" class="rounded-xl max-h-36 border border-white/10 hidden" />
            </div>
          </div>
        </div>
        <div class="md:col-span-3 mt-2">
          <button class="px-4 py-2 rounded-xl bg-emerald-600" type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Member Modal -->
  <div id="modalMember" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="bg-slate-800 rounded-2xl p-5 w-full max-w-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold" id="modalMemberTitle">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø¶Ùˆ</h3>
        <button class="px-2 py-1 rounded-lg bg-slate-700" onclick="closeModal('modalMember')">âœ•</button>
      </div>
      <form id="formMemberModal" class="grid md:grid-cols-2 gap-4">
        <input type="hidden" id="mm_id" />
        <div><label>Ù†Ø§Ù…</label><input id="mm_first_name" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label><input id="mm_last_name" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ø³Ø§Ù„ ÙˆØ±ÙˆØ¯</label><input id="mm_entry_year" type="number" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ù…Ù‚Ø·Ø¹ ØªØ­ØµÛŒÙ„ÛŒ</label><input id="mm_degree" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ</label><input id="mm_student_id" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</label><input id="mm_phone" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2"><label>Ø§ÛŒÙ…ÛŒÙ„</label><input id="mm_email" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2 mt-2">
          <button class="px-4 py-2 rounded-xl bg-emerald-600" type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loan Modal -->
  <div id="modalLoan" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="bg-slate-800 rounded-2xl p-5 w-full max-w-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold">ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù…Ø§Ù†Øª</h3>
        <button class="px-2 py-1 rounded-lg bg-slate-700" onclick="closeModal('modalLoan')">âœ•</button>
      </div>
      <form id="formLoanModal" class="grid md:grid-cols-2 gap-4">
        <input type="hidden" id="ml_id" />
        <div><label>ØªØ§Ø±ÛŒØ® Ø§Ù…Ø§Ù†Øª (Ù‡Ø¬Ø±ÛŒ Ø´Ù…Ø³ÛŒ)</label><input id="ml_borrowed" class="rounded-xl px-3 py-2 w-full" /></div>
        <div><label>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ù‡Ø¬Ø±ÛŒ Ø´Ù…Ø³ÛŒ)</label><input id="ml_due" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2"><label>ØªØ¹Ø¯Ø§Ø¯ ØªÙ…Ø¯ÛŒØ¯Ù‡Ø§</label><input id="ml_renewals" type="number" min="0" class="rounded-xl px-3 py-2 w-full" /></div>
        <div class="md:col-span-2 mt-2">
          <button class="px-4 py-2 rounded-xl bg-emerald-600" type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </form>
    </div>
  </div>

<script>
// ---------- Edit book & member implementations ----------
window.editBook = async function(input){
  try{
    let b = input;
    if(typeof input === 'number'){
      const { data, error } = await supabase.from('books').select('*').eq('id', input).maybeSingle();
      if(error || !data){ toast('Ú©ØªØ§Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
      b = data;
    }
    CURRENT_BOOK = b;
    document.getElementById('modalBookTitle').textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ú©ØªØ§Ø¨';
    document.getElementById('mb_id').value = b.id || '';
    document.getElementById('mb_title').value = b.title || '';
    document.getElementById('mb_author').value = b.author || '';
    document.getElementById('mb_translator').value = b.translator || '';
    document.getElementById('mb_subject').value = b.subject || '';
    document.getElementById('mb_keywords').value = Array.isArray(b.keywords) ? b.keywords.join(';') : (b.keywords || '');
    document.getElementById('mb_publisher').value = b.publisher || '';
    document.getElementById('mb_isbn').value = b.isbn || '';
    document.getElementById('mb_published_year').value = b.published_year || '';
    document.getElementById('mb_pages').value = b.pages || '';
    document.getElementById('mb_total_copies').value = b.total_copies || 1;
    const prev = document.getElementById('mb_cover_preview');
    const urlInp = document.getElementById('mb_cover_url');
    const clearChk = document.getElementById('mb_cover_clear');
    if(prev && b.cover_url){ prev.src = b.cover_url; prev.classList.remove('hidden'); } else if(prev){ prev.classList.add('hidden'); }
    if(urlInp){ urlInp.value = b.cover_url || ''; }
    if(clearChk){ clearChk.checked = false; }
    openModal('modalBook');
  }catch(e){ console.error(e); toast('Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ú©ØªØ§Ø¨'); }
};

window.editMember = async function(input){
  try{
    let m = input;
    if(typeof input === 'number'){
      const { data, error } = await supabase.from('members').select('*').eq('id', input).maybeSingle();
      if(error || !data){ toast('Ø¹Ø¶Ùˆ ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
      m = data;
    }
    document.getElementById('modalMemberTitle').textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø¶Ùˆ';
    document.getElementById('mm_id').value = m.id || '';
    document.getElementById('mm_first_name').value = m.first_name || '';
    document.getElementById('mm_last_name').value = m.last_name || '';
    document.getElementById('mm_entry_year').value = m.entry_year || '';
    document.getElementById('mm_degree').value = m.degree || '';
    document.getElementById('mm_student_id').value = m.student_id || '';
    document.getElementById('mm_phone').value = m.phone || '';
    document.getElementById('mm_email').value = m.email || '';
    openModal('modalMember');
  }catch(e){ console.error(e); toast('Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø¶Ùˆ'); }
};

// ---------- Prevent refresh & persist forms ----------
document.addEventListener('DOMContentLoaded', function(){
  const fb = document.getElementById('formBookModal');
  if(fb && !fb.dataset.bound){
    fb.addEventListener('submit', async function(e){
      e.preventDefault();
      try{
        const id = parseInt(document.getElementById('mb_id').value,10);
        const payload = {
          title: document.getElementById('mb_title').value.trim(),
          author: document.getElementById('mb_author').value.trim() || null,
          translator: document.getElementById('mb_translator').value.trim() || null,
          subject: document.getElementById('mb_subject').value.trim() || null,
          keywords: (document.getElementById('mb_keywords').value||'').split(';').map(s=>s.trim()).filter(Boolean),
          publisher: document.getElementById('mb_publisher').value.trim() || null,
          isbn: document.getElementById('mb_isbn').value.trim() || null,
          published_year: parseInt(document.getElementById('mb_published_year').value,10) || null,
          pages: parseInt(document.getElementById('mb_pages').value,10) || null,
          total_copies: parseInt(document.getElementById('mb_total_copies').value,10) || 1,
        };
        const { error } = await supabase.from('books').update(payload).eq('id', id);
        if(error) return toast(error.message);
        toast('Ú©ØªØ§Ø¨ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯'); closeModal('modalBook');
        if(typeof loadCatalog==='function') loadCatalog();
        if(typeof loadAdminBooks==='function') loadAdminBooks();
      }catch(err){ console.error(err); toast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©ØªØ§Ø¨'); }
    });
    fb.dataset.bound = '1';
  }

  const fm = document.getElementById('formMemberModal');
  if(fm && !fm.dataset.bound){
    fm.addEventListener('submit', async function(e){
      e.preventDefault();
      try{
        const id = parseInt(document.getElementById('mm_id').value,10);
        const payload = {
          first_name: document.getElementById('mm_first_name').value.trim() || null,
          last_name: document.getElementById('mm_last_name').value.trim() || null,
          entry_year: parseInt(document.getElementById('mm_entry_year').value,10) || null,
          degree: document.getElementById('mm_degree').value.trim() || null,
          student_id: document.getElementById('mm_student_id').value.trim() || null,
          phone: document.getElementById('mm_phone').value.trim() || null,
          email: document.getElementById('mm_email').value.trim() || null,
        };
        const { error } = await supabase.from('members').update(payload).eq('id', id);
        if(error) return toast(error.message);
        toast('Ø¹Ø¶Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯'); closeModal('modalMember');
        if(typeof loadMembers==='function') loadMembers();
      }catch(err){ console.error(err); toast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¹Ø¶Ùˆ'); }
    });
    fm.dataset.bound = '1';
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  function bind(){
    var base = {
      disableMobile: false,
      dateFormat: "Y/m/d",
      // use Persian locale if available
    };
    var borrowed = document.querySelector('#loan_borrowed');
    var due = document.querySelector('#loan_due');
    if(borrowed && !borrowed._fp){
    }
    if(due && !due._fp){
    }
    // Buttons
    [['btn_open_borrowed', borrowed], ['btn_open_due', due]].forEach(function([btnId, input]){
      var btn = document.getElementById(btnId);
      if(btn && input && !btn.dataset.bound){
        btn.addEventListener('click', function(e){
          e.preventDefault();
          if(input._fp){ input._fp.open(); }
          else{ input.focus(); }
        });
        btn.dataset.bound = '1';
      }
    });
  }
  bind();
  // Rebind when loans tab toggles visibility
  var tab = document.getElementById('tab-admin-loans');
  if(tab){
    var mo = new MutationObserver(function(){ bind(); });
    mo.observe(tab, {attributes:true, attributeFilter:['class','style']});
  }
});

</script>
</script>

<script>
// ---- Jalali (Jalaali) <-> Gregorian conversion helpers (no external deps) ----
// Source adapted from jalaali-js (ISC) by Behrang Noruzi Niya - inlined for offline use.
function div(a, b){ return Math.floor(a / b); }
function mod(a, b){ return a - Math.floor(a / b) * b; }
function jalCal(jy){
  var breaks = [-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];
  var bl = breaks.length, gy = jy + 621, leapJ = -14, jp = breaks[0], jm, jump, leap, n, i;
  for(i=1;i<bl;i++){
    jm = breaks[i]; jump = jm - jp;
    if(jy < jm) break;
    leapJ += div(jump,33)*8 + div(mod(jump,33),4); jp = jm;
  }
  n = jy - jp;
  leapJ += div(n,33)*8 + div(mod(n,33)+3,4);
  if(mod(jump,33)===4 && jump-n===4) leapJ += 1;
  var leapG = div(gy,4) - div((div(gy,100)+1)*3,4) - 150;
  var march = 20 + leapJ - leapG;
  if(jump-n < 6) n = n - jump + div(jump+4,33)*33;
  leap = mod(mod(n+1,33)-1,4);
  if(leap===-1) leap = 4;
  return { leap: leap===0, gy: gy, march: march };
}

function j2g(jy, jm, jd){
  jy = parseInt(jy,10) - 979;
  jm = parseInt(jm,10) - 1;
  jd = parseInt(jd,10) - 1;

  var j_day_no = 365*jy + div(jy,33)*8 + div(mod(jy,33)+3,4);
  for (var i=0; i<jm; ++i) j_day_no += (i<6 ? 31 : 30);
  j_day_no += jd;

  var g_day_no = j_day_no + 79;

  var gy = 1600 + 400*div(g_day_no,146097);
  g_day_no = mod(g_day_no,146097);

  var leap = true;
  if (g_day_no >= 36525){
    g_day_no--;
    gy += 100*div(g_day_no,36524);
    g_day_no = mod(g_day_no,36524);
    if (g_day_no >= 365){
      g_day_no++;
    } else {
      leap = false;
    }
  }

  gy += 4*div(g_day_no,1461);
  g_day_no = mod(g_day_no,1461);

  if (g_day_no >= 366){
    leap = false;
    g_day_no--;
    gy += div(g_day_no,365);
    g_day_no = mod(g_day_no,365);
  }

  var gd = g_day_no + 1;
  var sal_a = [0,31,(leap?29:28),31,30,31,30,31,31,30,31,30,31];
  var gm = 0;
  for (; gm<13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm];
  return [gy, gm, gd];
}
function g2j(gy, gm, gd){
  gy = parseInt(gy,10); gm = parseInt(gm,10); gd = parseInt(gd,10);
  var g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334];
  var gy2 = gy-1600, gm2 = gm-1, gd2 = gd-1;
  var g_day_no = 365*gy2 + div(gy2+3,4) - div(gy2+99,100) + div(gy2+399,400) + g_d_m[gm2] + gd2;
  if (gm2>1 && ((gy%4===0 && gy%100!==0) || (gy%400===0))) g_day_no++;
  var j_day_no = g_day_no - 79;
  var j_np = div(j_day_no,12053); j_day_no = mod(j_day_no,12053);
  var jy = 979 + 33*j_np + 4*div(j_day_no,1461); j_day_no = mod(j_day_no,1461);
  if (j_day_no >= 366){ jy += div(j_day_no-1,365); j_day_no = mod(j_day_no-1,365); }
  var jm, jd; 
  for (jm=0; jm<11 && j_day_no >= (jm<6?31:30); jm++) j_day_no -= (jm<6?31:30);
  jd = j_day_no + 1;
  return [jy, jm+1, jd];
}
function pad2(n){ return String(n).padStart(2,'0'); }
function fmtJ(y,m,d){ return `${y}/${pad2(m)}/${pad2(d)}`; }
// Helpers to normalize Persian/Arabic digits and validate Jalali input
function toEnDigits(s){ if(!s) return s; return s.replace(/[Û°-Û¹]/g,d=>'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)).replace(/[Ù -Ù©]/g,d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)).replace(/-/g,'/'); }
function normalizeJalali(s){ s=toEnDigits(String(s||'').trim()); const m=/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/.exec(s); if(!m) return ''; const y=+m[1], mo=+m[2], d=+m[3]; if(y<1200||y>1600||mo<1||mo>12) return ''; const md=(mo<=6)?31:((mo<=11)?30:29); if(d<1||d>md) return ''; return `${y}/${String(mo).padStart(2,'0')}/${String(d).padStart(2,'0')}`; }
</script>
<script>
// --- UTC-safe helpers to avoid DST / timezone drift ---
function addDaysUTC(date, days){
  const t = Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), 12, 0, 0);
  return new Date(t + days*24*3600*1000);
}
function isoFromJalaliUTC(y,m,d){
  const g = j2g(parseInt(y,10), parseInt(m,10), parseInt(d,10));
  return new Date(Date.UTC(g[0], g[1]-1, g[2], 12, 0, 0)).toISOString();
}
function jalaliFromISO(iso){
  const d = new Date(iso);
  const j = g2j(d.getUTCFullYear(), d.getUTCMonth()+1, d.getUTCDate());
  return fmtJ(j[0], j[1], j[2]);
}
</script>


<div id="extend-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="bg-slate-800 text-white rounded-2xl p-4 w-[90%] max-w-md space-y-3">
    <div class="text-lg font-bold">ØªÙ…Ø¯ÛŒØ¯ Ø§Ù…Ø§Ù†Øª</div>
    <div class="space-y-2">
      <label class="text-sm">ØªØ§Ø±ÛŒØ® Ø¬Ø¯ÛŒØ¯ Ø³Ø±Ø±Ø³ÛŒØ¯ (Ø´Ù…Ø³ÛŒ)</label>
      <input id="extend_due" type="text" data-jalali class="rounded-xl px-3 py-2 w-full bg-slate-700" placeholder="YYYY/MM/DD" />
    </div>
    <div class="flex gap-2 justify-end">
      <button id="extend_cancel" class="px-3 py-2 rounded-xl bg-slate-600">Ø§Ù†ØµØ±Ø§Ù</button>
      <button id="extend_ok" class="px-3 py-2 rounded-xl bg-indigo-600">Ø«Ø¨Øª ØªÙ…Ø¯ÛŒØ¯</button>
    </div>
  </div>
</div>

<!-- Edit Loan Modal -->
<div id="edit-loan-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="bg-slate-800 text-white rounded-2xl p-4 w-[95%] max-w-2xl space-y-4">
    <div class="text-lg font-bold">ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù…Ø§Ù†Øª</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="space-y-2">
        <label class="text-sm">Ø§Ù…Ø§Ù†Øªâ€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡</label>
        <input id="edit_member_query" type="text" class="rounded-xl px-3 py-2 w-full bg-slate-700" placeholder="Ù†Ø§Ù… / Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ / Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ" />
        <div id="edit_member_results" class="flex flex-wrap gap-1"></div>
        <div class="text-xs opacity-70">Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø§Ù…Ø§Ù†Øªâ€ŒÚ¯ÛŒØ±Ù†Ø¯Ù‡ØŒ Ù†Ø§Ù… Ø±Ø§ Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>
      </div>
      <div class="space-y-2">
        <label class="text-sm">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª Ø§Ù…Ø§Ù†Øª (Ø´Ù…Ø³ÛŒ)</label>
        <input id="edit_borrowed" type="text" data-jalali class="rounded-xl px-3 py-2 w-full bg-slate-700" placeholder="YYYY/MM/DD" readonly />
      </div>
      <div class="space-y-2">
        <label class="text-sm">ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ø´Ù…Ø³ÛŒ)</label>
        <input id="edit_due" type="text" data-jalali class="rounded-xl px-3 py-2 w-full bg-slate-700" placeholder="YYYY/MM/DD" />
      </div>
    </div>
    <div class="flex gap-2 justify-end pt-2">
      <button id="edit_loan_cancel" class="px-3 py-2 rounded-xl bg-slate-600">Ø§Ù†ØµØ±Ø§Ù</button>
      <button id="edit_loan_save" class="px-3 py-2 rounded-xl bg-indigo-600">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
    </div>
  </div>
</div>

<script>
</script>

<script>
async function setDefaultLoanDates(){
  try{
    let days = 14;
try{
  const { data: st } = await supabase.from('settings').select('default_loan_days').eq('id',1).maybeSingle();
  if(st && typeof st.default_loan_days === 'number') days = st.default_loan_days; window.__loan_days__ = days;
}catch(_){}
const now = new Date();
    const due = new Date(now.getTime() + days*24*3600*1000);

    const bEl = document.getElementById('loan_borrowed');
    const dEl = document.getElementById('loan_due');
    if(!bEl || !dEl) return;

    // Set input values as Jalali text
    const bj = g2j(now.getFullYear(), now.getMonth()+1, now.getDate());
    const dj = g2j(due.getFullYear(), due.getMonth()+1, due.getDate());
    if(bEl) bEl.value = fmtJ(bj[0], bj[1], bj[2]);
    if(dEl) dEl.value = fmtJ(dj[0], dj[1], dj[2]);

    // trailing setDate block removed
  }catch(e){}
}
</script>


<script>
// Minimal Jalali Datepicker (vanilla, no external libs)
(function(){
  function daysInJMonth(y,m){ return (m<=6)?31:((m<=11)?30:(g2j(j2g(y,12,30)[0], j2g(y,12,30)[1], j2g(y,12,30)[2])[2]===30?30:29)); }
  function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!=null) e.innerHTML=html; return e; }
  function pickFor(input){
    let val = normalizeJalali(input.value||''); 
    let jy, jm, jd;
    if(val){ const ps=val.split('/').map(x=>parseInt(x,10)); jy=ps[0]; jm=ps[1]; jd=ps[2]; }
    else { const d=new Date(); const j=g2j(d.getUTCFullYear(), d.getUTCMonth()+1, d.getUTCDate()); jy=j[0]; jm=j[1]; jd=j[2]; }
    const box = el('div','z-50 fixed inset-0 bg-black/30'); const wrap = el('div','fixed inset-0 flex items-center justify-center');
    const card = el('div','bg-slate-800 text-white rounded-2xl p-4 w-[320px]');
    const head = el('div','flex items-center justify-between mb-2');
    const btnL = el('button','px-2','â€¹'); const btnR = el('button','px-2','â€º'); const title = el('div','font-bold', jy+' / '+String(jm).padStart(2,'0'));
    head.append(btnL,title,btnR); card.append(head);
    const grid = el('div','grid grid-cols-7 gap-1');
    function render(){
      title.textContent = jy+' / '+String(jm).padStart(2,'0');
      grid.innerHTML='';
      const n = daysInJMonth(jy,jm);
      for(let d=1; d<=n; d++){
        const b=el('button','py-1 rounded hover:bg-slate-700', String(d).padStart(2,'0'));
        if(d===jd) b.classList.add('bg-slate-700');
        b.onclick = ()=>{ jd=d; input.value = fmtJ(jy,jm,jd); document.body.removeChild(box); };
        grid.append(b);
      }
    }
    btnL.onclick = ()=>{ jm--; if(jm<1){ jm=12; jy--; } render(); };
    btnR.onclick = ()=>{ jm++; if(jm>12){ jm=1; jy++; } render(); };
    card.append(grid);
    const foot = el('div','mt-3 flex justify-end gap-2');
    const cancel = el('button','px-3 py-1 bg-slate-600 rounded','Ø§Ù†ØµØ±Ø§Ù');
    cancel.onclick = ()=> document.body.removeChild(box);
    foot.append(cancel); card.append(foot);
    wrap.append(card); box.append(wrap); document.body.append(box); render();
  }
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.matches('input[data-jalali]')){ e.preventDefault(); pickFor(t); }
  });
})();
</script>

</body>
</html>
